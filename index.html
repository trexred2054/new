<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keuangan</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
            color: white;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            position: relative;
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .current-datetime {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .profile-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .profile-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }

        .profile-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .profile-value {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:disabled {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .date-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .date-mode-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 13px;
        }

        .date-mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .realtime-display {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            border: 2px solid #667eea;
        }

        .photo-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .photo-upload input[type="file"] {
            display: none;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 8px;
        }

        .photo-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .shopping-calculator {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .shopping-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .shopping-item input {
            padding: 8px;
            font-size: 13px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 13px;
            width: auto;
        }

        .shopping-total {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: right;
            font-weight: bold;
            color: #667eea;
            margin-top: 10px;
        }

        .debt-section {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }

        .debt-section label {
            color: #856404;
        }

        .interest-toggle {
            margin-bottom: 15px;
        }

        .interest-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .interest-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .interest-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
        }

        .interest-fields {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
        }

        .interest-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .interest-info {
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-income {
            background: #10b981;
            color: white;
        }

        .btn-expense {
            background: #ef4444;
            color: white;
        }

        .btn-delete {
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .btn-clear {
            background: #f59e0b;
            color: white;
            margin-top: 10px;
        }

        .btn-export {
            background: #06b6d4;
            color: white;
            margin-top: 10px;
        }

        .btn-import {
            background: #8b5cf6;
            color: white;
            margin-top: 10px;
        }

        .btn-pay {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
            margin-right: 5px;
        }

        .btn-paid-full {
            background: #059669;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
            margin-right: 5px;
        }

        .btn-history {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
            margin-right: 5px;
        }

        .btn-qty {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
            border-radius: 6px;
            font-weight: bold;
        }

        .btn-qty-minus {
            background: #ef4444;
        }

        .btn-qty-plus {
            background: #10b981;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-card h3 {
            font-size: 16px;
            color: #666;
            font-weight: 600;
        }

        .summary-card .amount {
            font-size: 24px;
            font-weight: bold;
            word-break: break-all;
            text-align: right;
        }

        .income {
            color: #10b981;
        }

        .expense {
            color: #ef4444;
        }

        .balance {
            color: #667eea;
        }

        .debt {
            color: #f59e0b;
        }

        .receivable {
            color: #14b8a6;
        }

        .period-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .year-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .year-nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .year-nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .year-nav-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .year-input {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            min-width: 100px;
            text-align: center;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 8px 12px;
            background: white;
            transition: all 0.3s;
        }

        .year-input:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .month-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .month-selector-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            display: block;
        }

        .month-dropdown {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-dropdown:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .month-dropdown:hover {
            background: #f9fafb;
        }

        .detail-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .detail-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-view-all {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }

        .btn-view-all:hover {
            background: #5568d3;
        }

        .btn-filter-detail {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
            margin-left: 5px;
        }

        .btn-filter-detail:hover {
            background: #7c3aed;
        }

        .filter-detail-dropdown {
            position: relative;
            display: inline-block;
        }

        .filter-detail-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-width: 250px;
            margin-top: 5px;
        }

        .filter-detail-menu.active {
            display: block;
        }

        .filter-detail-section {
            margin-bottom: 15px;
        }

        .filter-detail-section:last-child {
            margin-bottom: 0;
        }

        .filter-detail-label {
            font-weight: 600;
            color: #8b5cf6;
            margin-bottom: 8px;
            display: block;
            font-size: 13px;
        }

        .filter-detail-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-detail-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-detail-option:hover {
            background: #f3f4f6;
        }

        .filter-detail-option input[type="radio"],
        .filter-detail-option input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .filter-detail-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            font-size: 13px;
        }

        .filter-detail-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-apply-filter {
            flex: 1;
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .btn-reset-filter {
            flex: 1;
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .detail-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .detail-container.expanded {
            max-height: none;
            overflow-y: visible;
        }

        .detail-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .detail-desc {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .detail-amount {
            font-weight: bold;
            font-size: 16px;
        }

        .detail-specs {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .detail-specs div {
            margin-bottom: 3px;
        }

        .detail-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .detail-photo {
            margin-top: 10px;
        }

        .detail-photo img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .detail-photo img:hover {
            transform: scale(1.05);
        }

        .search-filter-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .search-box {
            position: relative;
            margin-bottom: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            border-color: #667eea;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }

        .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .clear-search.visible {
            display: flex;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-button {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s;
        }

        .filter-button:hover {
            background: #f9fafb;
        }

        .filter-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-top: 5px;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .filter-menu.active {
            display: block;
        }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-option:hover {
            background: #f0f7ff;
        }

        .filter-option.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .filter-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .transaction-desc {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .transaction-detail {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: bold;
            margin-right: 10px;
        }

        .transaction-photo {
            margin-top: 10px;
        }

        .transaction-photo img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .transaction-photo img:hover {
            transform: scale(1.05);
        }

        .storage-info {
            background: #eef2ff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            color: #667eea;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 50px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-dialog {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-dialog h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-dialog input, .modal-dialog textarea, .modal-dialog select {
            margin-bottom: 15px;
        }

        .modal-dialog-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-dialog-buttons button {
            flex: 1;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .hidden {
            display: none;
        }

        .debt-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-debt {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-receivable {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-overdue {
            background: #fee2e2;
            color: #991b1b;
            animation: pulse 2s infinite;
        }

        .badge-due-soon {
            background: #fef3c7;
            color: #92400e;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        .filter-group {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-header {
            background: #ef4444;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .notification-title {
            font-size: 18px;
            font-weight: bold;
        }

        .btn-close-notification {
            background: white;
            color: #ef4444;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .notification-content {
            padding: 20px;
        }

        .notification-item {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .notification-item-overdue {
            border-left-color: #dc2626;
            background: #fee2e2;
        }

        .notification-item-soon {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }

        .notification-desc {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .notification-detail {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .shop-mode-content {
            display: none;
        }

        .shop-mode-content.active {
            display: block;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: max-height 0.3s ease;
        }

        .products-grid.expanded {
            max-height: none;
            overflow-y: visible;
        }

        .product-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            position: relative;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .product-image-container {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 10px;
            color: white;
            overflow: hidden;
            position: relative;
        }

        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }

        .product-image-placeholder {
            font-size: 40px;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
            text-align: center;
        }

        .product-price {
            color: #667eea;
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 5px;
            text-align: center;
        }

        .product-stock {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-align: center;
        }

        .product-sold {
            font-size: 11px;
            color: #10b981;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }

        .product-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-direction: column;
        }

        .btn-product-menu {
            background: #667eea;
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }

        .btn-buy-product {
            background: #10b981;
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }

        .product-menu-popup {
            display: none;
            position: absolute;
            bottom: 90px;
            left: 12px;
            right: 12px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
            overflow: hidden;
        }

        .product-menu-popup.active {
            display: block;
        }

        .product-menu-item {
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .product-menu-item:hover {
            background: #f0f7ff;
        }

        .product-menu-item:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .sale-item {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .sale-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sale-item-name {
            font-weight: 600;
            font-size: 14px;
        }

        .sale-item-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .sale-item-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            align-items: center;
        }

        .settings-menu {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .settings-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-item:hover {
            background: #e5e7eb;
            transform: translateX(5px);
        }

        .settings-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
        }

        .settings-info h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .settings-info p {
            color: #666;
            font-size: 13px;
        }

        .product-search-box {
            margin-bottom: 15px;
            position: relative;
        }

        .product-search-input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .product-search-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .product-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }

        .product-clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: bold;
        }

        .product-clear-search.visible {
            display: flex;
        }

        .product-filter-box {
            margin-bottom: 15px;
        }

        .product-filter-button {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s;
        }

        .product-filter-button:hover {
            background: #f9fafb;
        }

        .product-filter-menu {
            display: none;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin-top: 5px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .product-filter-menu.active {
            display: block;
        }

        .product-filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .product-filter-option:hover {
            background: #f0f7ff;
        }

        .product-filter-option.selected {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .notification-filter-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ef4444;
        }

        .notification-filter-label {
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 10px;
            display: block;
        }

        .notification-filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .shopping-item {
                grid-template-columns: 1fr;
            }

            .period-tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .summary-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .summary-card .amount {
                text-align: center;
            }

            .notification-panel {
                width: 100%;
                right: -100%;
            }

            .header-buttons {
                flex-direction: column;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1>üí∞ Pencatat Keuangan</h1>
            <div class="header-buttons">
                <button class="btn-icon" onclick="toggleNotificationPanel()" id="btnNotification">
                    üì© Pesan
                    <span class="notification-badge hidden" id="notificationBadge">0</span>
                </button>
                <button class="btn-icon" onclick="showSettingsDialog()">‚öôÔ∏è Pengaturan</button>
            </div>
        </div>
        <div class="current-datetime" id="currentDateTime"></div>

        <div class="profile-card">
            <h2>üë§ Profil Pengguna</h2>
            <div class="profile-grid">
                <div class="profile-item">
                    <div class="profile-label">Nama</div>
                    <div class="profile-value" id="displayUserName">-</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">Nama Usaha</div>
                    <div class="profile-value" id="displayBusinessName">-</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">Alamat</div>
                    <div class="profile-value" id="displayAddress">-</div>
                </div>
                <div class="profile-item">
                    <div class="profile-label">Info Tambahan</div>
                    <div class="profile-value" id="displayAdditionalInfo">-</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>‚ûï Input</h2>
                <div class="storage-info" id="storageInfo">
                    ‚úì Data tersimpan otomatis di browser
                </div>

                <div class="mode-selector">
                    <button type="button" class="mode-btn active" id="mainModeBtn" onclick="setMainMode('transaction')">
                        ‚ûï Transaksi
                    </button>
                    <button type="button" class="mode-btn" id="shopModeBtn" onclick="setMainMode('shop')">
                        üõí Toko
                    </button>
                </div>

                <div id="transactionModeContent">
                    <form id="transactionForm" onsubmit="handleTransactionSubmit(event)">
                        <div class="form-group">
                            <label>Tipe Transaksi</label>
                            <select id="type" required onchange="toggleDebtSection()">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                                <option value="debt">Hutang (Saya Berhutang)</option>
                                <option value="receivable">Piutang (Orang Berhutang Ke Saya)</option>
                            </select>
                        </div>

                        <div id="debtSection" class="debt-section hidden">
                            <div class="form-group">
                                <label id="debtTypeLabel">Jenis Hutang</label>
                                <select id="debtType"></select>
                            </div>
                            <div class="form-group">
                                <label id="debtLabel">Nama Orang/Tempat</label>
                                <input type="text" id="debtPerson" placeholder="Nama orang atau tempat">
                            </div>
                            <div class="form-group">
                                <label>Jatuh Tempo (Tanggal & Waktu)</label>
                                <input type="datetime-local" id="debtDueDate">
                            </div>
    
                            <div class="interest-toggle">
                                <div class="interest-checkbox">
                                    <input type="checkbox" id="hasInterest" onchange="toggleInterestFields()">
                                    <label for="hasInterest">üí∞ Pakai Bunga</label>
                                </div>
                            </div>
    
                            <div id="interestFields" class="interest-fields hidden">
                                <div class="interest-row">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Bunga (%)</label>
                                        <input type="text" id="interestRate" placeholder="2.5" oninput="formatInterestInput(this); calculateInterestPreview()">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Per</label>
                                        <select id="interestPeriod" onchange="calculateInterestPreview()">
                                            <option value="day">Hari</option>
                                            <option value="week">Minggu</option>
                                            <option value="month">Bulan</option>
                                            <option value="year">Tahun</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="interest-info" id="interestPreview">
                                    Preview bunga akan muncul di sini
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Mode Pencatatan</label>
                            <div class="mode-selector">
                                <button type="button" class="mode-btn active" id="quickModeBtn" onclick="setInputMode('quick')">
                                    ‚ö° Cepat
                                </button>
                                <button type="button" class="mode-btn" id="detailModeBtn" onclick="setInputMode('detail')">
                                    üìã Detail
                                </button>
                            </div>
                        </div>

                        <div id="quickMode">
                            <div class="form-group">
                                <label>Jumlah (Rp)</label>
                                <input type="text" id="quickAmount" placeholder="50.000" oninput="formatAmountInput(this); calculateInterestPreview()">
                            </div>
                        
                            <div class="form-group">
                                <label>Deskripsi</label>
                                <input type="text" id="quickDescription" placeholder="Nama transaksi">
                            </div>
                        </div>
                        
                        <div id="detailMode" class="hidden">
                            <div class="form-group">
                                <label>Nama Barang/Transaksi</label>
                                <input type="text" id="detailDescription" placeholder="Contoh: Beras, Gula, Minyak">
                            </div>

                            <div class="form-group">
                                <label>Kalkulator Harga üõí</label>
                                <div class="shopping-calculator">
                                    <div class="shopping-item">
                                        <input type="text" id="itemPrice" placeholder="Harga Satuan" oninput="formatAmountInput(this); calculateDetailTotal()">
                                        <input type="number" id="itemQty" placeholder="Jumlah" min="1" value="1" oninput="calculateDetailTotal()">
                                    </div>
                                    <div class="shopping-total">
                                        Total: <span id="shoppingTotal">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Catatan Tambahan (Opsional)</label>
                            <textarea id="notes" placeholder="Catatan lainnya..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Mode Tanggal & Waktu</label>
                            <div class="date-mode-selector">
                                <button type="button" class="date-mode-btn active" id="autoDateBtn" onclick="setDateMode('auto')">
                                    üïê Otomatis
                                </button>
                                <button type="button" class="date-mode-btn" id="manualDateBtn" onclick="setDateMode('manual')">
                                    üìÖ Manual
                                </button>
                            </div>
                            
                            <div id="autoDateDisplay" class="realtime-display">
                                <div id="autoDateText"></div>
                            </div>
                            
                            <div id="manualDateInput" class="hidden">
                                <input type="datetime-local" id="manualDatetime">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Foto Struk/Bukti (Max 20MB)</label>
                            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                                <input type="file" id="photoInput" accept="image/*" onchange="previewPhoto(event)">
                                <div id="photoUploadText">üì∑ Klik untuk upload foto</div>
                                <img id="photoPreview" class="photo-preview" style="display:none">
                                <div id="photoInfo" class="photo-info"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn-income">Tambah Transaksi</button>
                    </form>
                </div>

                <div id="shopModeContent" class="shop-mode-content">
                    <div class="form-group">
                        <button type="button" class="btn-income" onclick="showAddProductDialog()">‚ûï Tambah Produk</button>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label style="margin-bottom: 0;">Daftar Produk</label>
                            <button type="button" class="btn-view-all" onclick="toggleProductsExpanded()" id="btnToggleProducts">‚ñº Lihat Semua</button>
                        </div>
                        <div class="product-search-box">
                            <span class="product-search-icon">üîç</span>
                            <input type="text" class="product-search-input" id="productSearchInput" placeholder="Cari produk..." oninput="handleProductSearch()">
                            <button class="product-clear-search" id="productClearSearch" onclick="clearProductSearch()">‚úï</button>
                        </div>
                        <div class="product-filter-box">
                            <button class="product-filter-button" onclick="toggleProductFilter()">
                                <span id="productFilterLabel">Urutkan: Terbaru</span>
                                <span>‚ñº</span>
                            </button>
                            <div class="product-filter-menu" id="productFilterMenu">
                                <div class="product-filter-option selected" data-filter="newest" onclick="selectProductFilter('newest')">
                                    Terbaru
                                </div>
                                <div class="product-filter-option" data-filter="name-asc" onclick="selectProductFilter('name-asc')">
                                    Nama (A-Z)
                                </div>
                                <div class="product-filter-option" data-filter="name-desc" onclick="selectProductFilter('name-desc')">
                                    Nama (Z-A)
                                </div>
                                <div class="product-filter-option" data-filter="price-asc" onclick="selectProductFilter('price-asc')">
                                    Harga Termurah
                                </div>
                                <div class="product-filter-option" data-filter="price-desc" onclick="selectProductFilter('price-desc')">
                                    Harga Termahal
                                </div>
                                <div class="product-filter-option" data-filter="stock-asc" onclick="selectProductFilter('stock-asc')">
                                    Stok Terkecil
                                </div>
                                <div class="product-filter-option" data-filter="stock-desc" onclick="selectProductFilter('stock-desc')">
                                    Stok Terbanyak
                                </div>
                                <div class="product-filter-option" data-filter="sold-count" onclick="selectProductFilter('sold-count')">
                                    Terlaris (Jumlah Terjual)
                                </div>
                                <div class="product-filter-option" data-filter="sold-value" onclick="selectProductFilter('sold-value')">
                                    Terlaris (Total Penjualan)
                                </div>
                            </div>
                        </div>
                        <div class="products-grid" id="productsList">
                            <p class="no-data">Belum ada produk</p>
                        </div>
                    </div>

                    <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">

                    <h3 style="color: #667eea; margin-bottom: 15px;">Transaksi Penjualan</h3>

                    <div id="buyDirectMode">
                        <div class="form-group">
                            <label>Daftar Barang Dipilih</label>
                            <div id="directSaleItemsList">
                                <p class="no-data">Belum ada barang dipilih</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Subtotal:</span>
                                    <span id="directSaleSubtotal" style="font-weight: bold; color: #667eea;">Rp 0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 600; font-size: 18px;">Total:</span>
                                    <span id="directSaleTotal" style="font-weight: bold; font-size: 20px; color: #10b981;">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Metode Pembayaran</label>
                            <select id="directSalePaymentMethod" onchange="toggleDirectSaleDebtFields()">
                                <option value="cash">Tunai</option>
                                <option value="credit">Piutang (Orang Berhutang Ke Saya)</option>
                            </select>
                        </div>

                        <div id="directSaleDebtFields" class="hidden">
                            <div class="form-group">
                                <label>Nama Pembeli</label>
                                <input type="text" id="directSaleBuyerName" placeholder="Nama pembeli">
                            </div>
                            <div class="form-group">
                                <label>Jatuh Tempo</label>
                                <input type="datetime-local" id="directSaleDueDate">
                            </div>
    
                            <div class="interest-toggle">
                                <div class="interest-checkbox">
                                    <input type="checkbox" id="directSaleHasInterest" onchange="toggleDirectSaleInterestFields()">
                                    <label for="directSaleHasInterest">üí∞ Pakai Bunga</label>
                                </div>
                            </div>
    
                            <div id="directSaleInterestFields" class="interest-fields hidden">
                                <div class="interest-row">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Bunga (%)</label>
                                        <input type="text" id="directSaleInterestRate" placeholder="2.5" oninput="formatInterestInput(this); calculateDirectSaleInterestPreview()">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Per</label>
                                        <select id="directSaleInterestPeriod" onchange="calculateDirectSaleInterestPreview()">
                                            <option value="day">Hari</option>
                                            <option value="week">Minggu</option>
                                            <option value="month">Bulan</option>
                                            <option value="year">Tahun</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="interest-info" id="directSaleInterestPreview">
                                    Preview bunga akan muncul di sini
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Catatan (Opsional)</label>
                            <textarea id="directSaleNotes" placeholder="Catatan transaksi..."></textarea>
                        </div>

                        <button type="button" class="btn-income" onclick="processDirectSale()">üí∞ Proses Penjualan</button>
                    </div>
                </div>
            </div>

            <div>
                <div class="period-tabs" id="summaryPeriodTabs">
                    <button class="tab active" onclick="changePeriod('day')">Hari Ini</button>
                    <button class="tab" onclick="changePeriod('week')">Minggu Ini</button>
                    <button class="tab" onclick="changePeriod('month')">Bulan Ini</button>
                    <button class="tab" onclick="changePeriod('year')">Tahun Ini</button>
                    <button class="tab" onclick="changePeriod('previous')">Tahun Sebelumnya</button>
                </div>

                <div id="yearNavigation" class="year-navigation hidden">
                    <button class="year-nav-btn" onclick="navigateYear(-1)">‚óÄ Tahun Sebelumnya</button>
                    <input type="number" class="year-input" id="yearInput" min="1" onchange="changeYearManual()">
                    <button class="year-nav-btn" onclick="navigateYear(1)" id="nextYearBtn">Tahun Berikutnya ‚ñ∂</button>
                </div>

                <div id="monthSelector" class="month-selector hidden">
                    <label class="month-selector-label">Pilih Bulan:</label>
                    <select class="month-dropdown" id="monthDropdown" onchange="changeMonth(this.value)">
                        <option value="all">Semua Bulan</option>
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Pemasukan</h3>
                        <div class="amount income" id="totalIncome">Rp 0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Pengeluaran</h3>
                        <div class="amount expense" id="totalExpense">Rp 0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Saldo</h3>
                        <div class="amount balance" id="totalBalance">Rp 0</div>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Total Hutang</h3>
                        <div class="amount debt" id="totalDebt">Rp 0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Piutang</h3>
                        <div class="amount receivable" id="totalReceivable">Rp 0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Saldo Bersih</h3>
                        <div class="amount balance" id="netBalance">Rp 0</div>
                    </div>
                </div>

                <div class="detail-section" id="incomeDetails">
                    <h4>
                        <span>üìà Detail Pemasukan (0)</span>
                        <div>
                            <button class="btn-filter-detail" onclick="toggleIncomeFilter()">üîΩ Filter</button>
                            <button class="btn-view-all" onclick="toggleIncomeExpanded()">‚ñº Lihat Semua</button>
                            <div class="filter-detail-dropdown" style="display: inline-block;">
                                <div class="filter-detail-menu" id="incomeFilterMenu">
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Urutkan:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="incomeSort" value="date-desc" checked id="incomeSort1">
                                                <label for="incomeSort1">Terbaru</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="incomeSort" value="date-asc" id="incomeSort2">
                                                <label for="incomeSort2">Terlama</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="incomeSort" value="amount-desc" id="incomeSort3">
                                                <label for="incomeSort3">Tertinggi</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="incomeSort" value="amount-asc" id="incomeSort4">
                                                <label for="incomeSort4">Terendah</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Rentang Nominal:</label>
                                        <input type="text" placeholder="Min" id="incomeMinAmount" value="" oninput="formatAmountInput(this)" style="margin-bottom: 5px;">
                                        <input type="text" placeholder="Max" id="incomeMaxAmount" value="" oninput="formatAmountInput(this)">
                                    </div>
                                    <div class="filter-detail-buttons">
                                        <button class="btn-apply-filter" onclick="applyIncomeFilter()">Terapkan</button>
                                        <button class="btn-reset-filter" onclick="resetIncomeFilter()">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h4>
                    <div class="detail-container">
                        <p class="no-data">Belum ada pemasukan</p>
                    </div>
                </div>

                <div class="detail-section" id="expenseDetails">
                    <h4>
                        <span>üìâ Detail Pengeluaran (0)</span>
                        <div>
                            <button class="btn-filter-detail" onclick="toggleExpenseFilter()">üîΩ Filter</button>
                            <button class="btn-view-all" onclick="toggleExpenseExpanded()">‚ñº Lihat Semua</button>
                            <div class="filter-detail-dropdown" style="display: inline-block;">
                                <div class="filter-detail-menu" id="expenseFilterMenu">
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Urutkan:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="expenseSort" value="date-desc" checked id="expenseSort1">
                                                <label for="expenseSort1">Terbaru</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="expenseSort" value="date-asc" id="expenseSort2">
                                                <label for="expenseSort2">Terlama</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="expenseSort" value="amount-desc" id="expenseSort3">
                                                <label for="expenseSort3">Tertinggi</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="expenseSort" value="amount-asc" id="expenseSort4">
                                                <label for="expenseSort4">Terendah</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Rentang Nominal:</label>
                                        <input type="text" placeholder="Min" id="expenseMinAmount" value="" oninput="formatAmountInput(this)" style="margin-bottom: 5px;">
                                        <input type="text" placeholder="Max" id="expenseMaxAmount" value="" oninput="formatAmountInput(this)">
                                    </div>
                                    <div class="filter-detail-buttons">
                                        <button class="btn-apply-filter" onclick="applyExpenseFilter()">Terapkan</button>
                                        <button class="btn-reset-filter" onclick="resetExpenseFilter()">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h4>
                    <div class="detail-container">
                        <p class="no-data">Belum ada pengeluaran</p>
                    </div>
                </div>

                <div class="detail-section" id="debtDetailsSection">
                    <h4>
                        <span>üí≥ Detail Hutang (0)</span>
                        <div>
                            <button class="btn-filter-detail" onclick="toggleDebtFilter()">üîΩ Filter</button>
                            <button class="btn-view-all" onclick="toggleDebtExpanded()">‚ñº Lihat Semua</button>
                            <div class="filter-detail-dropdown" style="display: inline-block;">
                                <div class="filter-detail-menu" id="debtFilterMenu">
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Status:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtStatus" value="all" checked id="debtStatus1">
                                                <label for="debtStatus1">Semua</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtStatus" value="unpaid" id="debtStatus2">
                                                <label for="debtStatus2">Belum Lunas</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtStatus" value="paid" id="debtStatus3">
                                                <label for="debtStatus3">Lunas</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Urutkan:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtSort" value="date-desc" checked id="debtSort1">
                                                <label for="debtSort1">Terbaru</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtSort" value="date-asc" id="debtSort2">
                                                <label for="debtSort2">Terlama</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtSort" value="amount-desc" id="debtSort3">
                                                <label for="debtSort3">Tertinggi</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="debtSort" value="amount-asc" id="debtSort4">
                                                <label for="debtSort4">Terendah</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-buttons">
                                        <button class="btn-apply-filter" onclick="applyDebtFilter()">Terapkan</button>
                                        <button class="btn-reset-filter" onclick="resetDebtFilter()">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h4>
                    <div class="detail-container">
                        <p class="no-data">Belum ada hutang</p>
                    </div>
                </div>

                <div class="detail-section" id="receivableDetailsSection">
                    <h4>
                        <span>üí∞ Detail Piutang (0)</span>
                        <div>
                            <button class="btn-filter-detail" onclick="toggleReceivableFilter()">üîΩ Filter</button>
                            <button class="btn-view-all" onclick="toggleReceivableExpanded()">‚ñº Lihat Semua</button>
                            <div class="filter-detail-dropdown" style="display: inline-block;">
                                <div class="filter-detail-menu" id="receivableFilterMenu">
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Status:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableStatus" value="all" checked id="receivableStatus1">
                                                <label for="receivableStatus1">Semua</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableStatus" value="unpaid" id="receivableStatus2">
                                                <label for="receivableStatus2">Belum Lunas</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableStatus" value="paid" id="receivableStatus3">
                                                <label for="receivableStatus3">Lunas</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-section">
                                        <label class="filter-detail-label">Urutkan:</label>
                                        <div class="filter-detail-options">
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableSort" value="date-desc" checked id="receivableSort1">
                                                <label for="receivableSort1">Terbaru</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableSort" value="date-asc" id="receivableSort2">
                                                <label for="receivableSort2">Terlama</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableSort" value="amount-desc" id="receivableSort3">
                                                <label for="receivableSort3">Tertinggi</label>
                                            </div>
                                            <div class="filter-detail-option">
                                                <input type="radio" name="receivableSort" value="amount-asc" id="receivableSort4">
                                                <label for="receivableSort4">Terendah</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-detail-buttons">
                                        <button class="btn-apply-filter" onclick="applyReceivableFilter()">Terapkan</button>
                                        <button class="btn-reset-filter" onclick="resetReceivableFilter()">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h4>
                    <div class="detail-container">
                        <p class="no-data">Belum ada piutang</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Riwayat Transaksi (<span id="transactionCount">0</span>)</h2>
    
            <div class="period-tabs" id="historyPeriodTabs">
                <button class="tab active" onclick="changeHistoryPeriod('all')">Semua</button>
                <button class="tab" onclick="changeHistoryPeriod('day')">Hari Ini</button>
                <button class="tab" onclick="changeHistoryPeriod('week')">Minggu Ini</button>
                <button class="tab" onclick="changeHistoryPeriod('month')">Bulan Ini</button>
                <button class="tab" onclick="changeHistoryPeriod('year')">Tahun Ini</button>
                <button class="tab" onclick="changeHistoryPeriod('previous')">Tahun Sebelumnya</button>
            </div>

            <div id="historyYearNavigation" class="year-navigation hidden">
                <button class="year-nav-btn" onclick="navigateHistoryYear(-1)">‚óÄ Tahun Sebelumnya</button>
                <input type="number" class="year-input" id="historyYearInput" min="1" onchange="changeHistoryYearManual()">
                <button class="year-nav-btn" onclick="navigateHistoryYear(1)" id="historyNextYearBtn">Tahun Berikutnya ‚ñ∂</button>
            </div>

            <div id="historyMonthSelector" class="month-selector hidden">
                <label class="month-selector-label">Pilih Bulan:</label>
                <select class="month-dropdown" id="historyMonthDropdown" onchange="changeHistoryMonth(this.value)">
                    <option value="all">Semua Bulan</option>
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                </select>
            </div>

            <div class="search-filter-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Cari transaksi..." oninput="handleSearch()">
                    <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
                </div>
                <div class="filter-dropdown">
                    <button class="filter-button" onclick="toggleFilterMenu()">
                        <span>
                            <span id="filterLabel">Filter: Semua</span>
                            <span class="filter-badge" id="filterBadge" style="display:none;">0</span>
                        </span>
                        <span>‚ñº</span>
                    </button>
                    <div class="filter-menu" id="filterMenu">
                        <div class="filter-option selected" data-filter="all" onclick="selectFilter('all')">
                            ‚úì Semua Transaksi
                        </div>
                        <div class="filter-option" data-filter="income" onclick="selectFilter('income')">
                            üìà Pemasukan
                        </div>
                        <div class="filter-option" data-filter="expense" onclick="selectFilter('expense')">
                            üìâ Pengeluaran
                        </div>
                        <div class="filter-option" data-filter="debt" onclick="selectFilter('debt')">
                            üí≥ Hutang
                        </div>
                        <div class="filter-option" data-filter="receivable" onclick="selectFilter('receivable')">
                            üí∞ Piutang (Orang Berhutang Ke Saya)
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="transaction-list" id="transactionList">
                <p class="no-data">Belum ada transaksi</p>
            </div>
        </div>
    </div>

    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <div class="notification-title">üì© Pesan Jatuh Tempo</div>
            <button class="btn-close-notification" onclick="toggleNotificationPanel()">‚úï</button>
        </div>
        <div class="notification-content">
            <div class="notification-filter-box">
                <label class="notification-filter-label">Filter Notifikasi:</label>
                <div class="notification-filter-row">
                    <select id="notificationPriceFilter" onchange="filterNotifications()">
                        <option value="all">Semua Harga</option>
                        <option value="low">< Rp 100.000</option>
                        <option value="medium">Rp 100.000 - 1.000.000</option>
                        <option value="high">> Rp 1.000.000</option>
                    </select>
                    <select id="notificationTimeFilter" onchange="filterNotifications()">
                        <option value="all">Semua Waktu</option>
                        <option value="overdue">Sudah Lewat</option>
                        <option value="today">Hari Ini</option>
                        <option value="week">Minggu Ini</option>
                    </select>
                </div>
                <div style="margin-top: 10px;">
                    <select id="notificationTypeFilter" onchange="filterNotifications()">
                        <option value="all">Semua Tipe</option>
                        <option value="debt">Hutang Saja</option>
                        <option value="receivable">Piutang Saja</option>
                    </select>
                </div>
            </div>
            <div id="notificationContent">
                <p class="no-data">Tidak ada notifikasi jatuh tempo</p>
            </div>
        </div>
    </div>

    <div id="photoModal" class="modal" onclick="closePhotoModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <div class="modal-dialog" id="settingsDialog">
        <h3>‚öôÔ∏è Pengaturan</h3>
        <div class="settings-menu">
            <div class="settings-item" onclick="showProfileDialog()">
                <div class="settings-icon">üë§</div>
                <div class="settings-info">
                    <h4>Profil Pengguna</h4>
                    <p>Atur informasi profil Anda</p>
                </div>
            </div>
            <div class="settings-item" onclick="closeSettingsDialog(); handleExportJSONClick();">
                <div class="settings-icon">üì•</div>
                <div class="settings-info">
                    <h4>Download Data (JSON)</h4>
                    <p>Download backup data ke JSON</p>
                </div>
            </div>
            <div class="settings-item" onclick="closeSettingsDialog(); handleExportExcelClick();">
                <div class="settings-icon">üìä</div>
                <div class="settings-info">
                    <h4>Download Data (Excel)</h4>
                    <p>Download data ke Excel</p>
                </div>
            </div>
            <div class="settings-item" onclick="closeSettingsDialog(); handleImportClick();">
                <div class="settings-icon">üì§</div>
                <div class="settings-info">
                    <h4>Import Data</h4>
                    <p>Import data dari file backup JSON</p>
                </div>
            </div>
            <div class="settings-item" onclick="closeSettingsDialog(); clearAllData();">
                <div class="settings-icon">üóëÔ∏è</div>
                <div class="settings-info">
                    <h4>Hapus Semua Data</h4>
                    <p>Hapus semua transaksi</p>
                </div>
            </div>
        </div>
        <div class="modal-dialog-buttons" style="margin-top: 20px;">
            <button class="btn-clear" onclick="closeSettingsDialog()">Tutup</button>
        </div>
    </div>

    <div class="modal-dialog" id="profileDialog">
        <h3>üë§ Edit Profil Pengguna</h3>
        <div class="form-group">
            <label>Nama *</label>
            <input type="text" id="profileUserName" placeholder="Masukkan nama Anda" required>
        </div>
        <div class="form-group">
            <label>Nama Usaha</label>
            <input type="text" id="profileBusinessName" placeholder="Contoh: Toko Maju Jaya">
        </div>
        <div class="form-group">
            <label>Alamat</label>
            <textarea id="profileAddress" placeholder="Alamat lengkap"></textarea>
        </div>
        <div class="form-group">
            <label>Info Tambahan</label>
            <textarea id="profileAdditionalInfo" placeholder="Nomor telepon, email, atau info lainnya"></textarea>
        </div>
        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmProfileSave()">üíæ Simpan</button>
            <button class="btn-clear" onclick="closeProfileDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="exportDialog">
        <h3>üìä Download Data ke Excel</h3>
        
        <div class="form-group">
            <label>Nama File (tanpa ekstensi)</label>
            <input type="text" id="exportFileName" placeholder="Laporan_Keuangan">
        </div>

        <div class="form-group">
            <label>Pilih Tipe Data</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="exportAll" checked onchange="toggleExportAll()">
                    <label for="exportAll">Semua Data</label>
                </div>
            </div>
            <div class="checkbox-group" style="margin-top: 10px; padding-left: 20px;">
                <div class="checkbox-item">
                    <input type="checkbox" id="exportIncome" disabled>
                    <label for="exportIncome">Pemasukan</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportExpense" disabled>
                    <label for="exportExpense">Pengeluaran</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportDebt" disabled>
                    <label for="exportDebt">Hutang</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="exportReceivable" disabled>
                    <label for="exportReceivable">Piutang</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Pilih Periode Waktu</label>
            <select id="exportPeriod" onchange="toggleExportDateInputs()">
                <option value="all">Semua Waktu</option>
                <option value="today">Hari Ini</option>
                <option value="week">Minggu Ini</option>
                <option value="month">Bulan Ini</option>
                <option value="year">Tahun Ini</option>
                <option value="custom">Custom (Pilih Tanggal)</option>
            </select>
        </div>

        <div id="exportCustomDates" class="hidden">
            <div class="filter-row">
                <div class="form-group">
                    <label>Dari Tanggal</label>
                    <input type="date" id="exportStartDate">
                </div>
                <div class="form-group">
                    <label>Sampai Tanggal</label>
                    <input type="date" id="exportEndDate">
                </div>
            </div>
        </div>

        <div class="modal-dialog-buttons">
            <button class="btn-export" onclick="confirmExport()">üíæ Download Excel</button>
            <button class="btn-clear" onclick="closeExportDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="importDialog">
        <h3>üì§ Import Data</h3>
        <p style="margin-bottom: 20px; color: #666;">Pilih bagaimana Anda ingin mengimport data:</p>
        
        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 10px;">üìã Preview:</div>
            <div id="importPreview" style="font-size: 14px; color: #666;">
                Ditemukan <span id="importCount" style="font-weight: bold; color: #667eea;">0</span> transaksi
            </div>
        </div>

        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmImport('merge')">
                ‚ûï Gabungkan dengan Data Lama
            </button>
            <button class="btn-expense" onclick="confirmImport('replace')">
                üîÑ Ganti Data Lama (Hapus Semua)
            </button>
            <button class="btn-clear" onclick="closeImportDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="paymentDialog">
        <h3 id="paymentTitle">üíµ Bayar Cicilan</h3>
        <div class="form-group">
            <label>Jumlah Pembayaran (Rp)</label>
            <input type="text" id="paymentAmount" placeholder="50.000" oninput="formatAmountInput(this)">
        </div>
        <div class="form-group">
            <label>Catatan (Opsional)</label>
            <input type="text" id="paymentNote" placeholder="Cicilan ke-1, dll">
        </div>
        <div class="form-group">
            <label>Jatuh Tempo Berikutnya (Opsional)</label>
            <input type="datetime-local" id="paymentNextDueDate" placeholder="Kosongkan jika tidak ada cicilan lagi">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                üí° Isi jika masih ada cicilan berikutnya
            </div>
        </div>
        <div class="form-group">
            <label>Foto Bukti Pembayaran (Max 20MB)</label>
            <div class="photo-upload" onclick="document.getElementById('paymentPhotoInput').click()">
                <input type="file" id="paymentPhotoInput" accept="image/*" onchange="previewPaymentPhoto(event)">
                <div id="paymentPhotoUploadText">üì∑ Klik untuk upload foto</div>
                <img id="paymentPhotoPreview" class="photo-preview" style="display:none">
                <div id="paymentPhotoInfo" class="photo-info"></div>
            </div>
        </div>
        <div style="background: #f9fafb; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Sisa Hutang/Piutang:</div>
            <div style="font-size: 18px; font-weight: bold; color: #667eea;" id="remainingAmount">Rp 0</div>
            <div style="font-size: 12px; color: #f59e0b; margin-top: 8px; padding: 8px; background: #fef3c7; border-radius: 6px;">
                üí° <strong>Tips:</strong> Jika ini cicilan (bukan pelunasan), Anda bisa mengatur jatuh tempo cicilan berikutnya di atas.
            </div>
        </div>
        <div class="modal-dialog-buttons">
            <button class="btn-pay" onclick="confirmPayment(false)">üí∞ Bayar Cicilan</button>
            <button class="btn-paid-full" onclick="confirmPayment(true)">‚úÖ Lunas</button>
            <button class="btn-clear" onclick="closePaymentDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="historyDialog">
        <h3>üìú Riwayat Pembayaran</h3>
        <div id="historyContent"></div>
        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="closeHistoryDialog()">Tutup</button>
        </div>
    </div>

    <div class="modal-dialog" id="editTransactionDialog">
        <h3>‚úèÔ∏è Edit Transaksi</h3>
        
        <div class="form-group">
            <label>Mode Pencatatan</label>
            <div class="mode-selector">
                <button type="button" class="mode-btn active" id="editQuickModeBtn" onclick="setEditInputMode('quick')">
                    ‚ö° Cepat
                </button>
                <button type="button" class="mode-btn" id="editDetailModeBtn" onclick="setEditInputMode('detail')">
                    üìã Detail
                </button>
            </div>
        </div>

        <div class="form-group">
            <label>Tipe Transaksi</label>
            <select id="editType" onchange="toggleEditDebtSection()">
                <option value="income">Pemasukan</option>
                <option value="expense">Pengeluaran</option>
                <option value="debt">Hutang (Saya Berhutang)</option>
                <option value="receivable">Piutang (Orang Berhutang Ke Saya)</option>
            </select>
        </div>

        <div id="editDebtSection" class="debt-section hidden">
            <div class="form-group">
                <label id="editDebtLabel">Nama Orang/Tempat</label>
                <input type="text" id="editDebtPerson" placeholder="Nama orang atau tempat">
            </div>
            <div class="form-group">
                <label>Jatuh Tempo (Tanggal & Waktu)</label>
                <input type="datetime-local" id="editDebtDueDate">
            </div>
        </div>

        <div id="editQuickMode">
            <div class="form-group">
                <label>Jumlah (Rp)</label>
                <input type="text" id="editQuickAmount" placeholder="50.000" oninput="formatAmountInput(this)">
            </div>
        
            <div class="form-group">
                <label>Deskripsi</label>
                <input type="text" id="editQuickDescription" placeholder="Nama transaksi">
            </div>
        </div>
        
        <div id="editDetailMode" class="hidden">
            <div class="form-group">
                <label>Nama Barang/Transaksi</label>
                <input type="text" id="editDetailDescription" placeholder="Contoh: Beras, Gula, Minyak">
            </div>

            <div class="form-group">
                <label>Kalkulator Harga üõí</label>
                <div class="shopping-calculator">
                    <div class="shopping-item">
                        <input type="text" id="editItemPrice" placeholder="Harga Satuan" oninput="formatAmountInput(this); calculateEditDetailTotal()">
                        <input type="number" id="editItemQty" placeholder="Jumlah" min="1" value="1" oninput="calculateEditDetailTotal()">
                    </div>
                    <div class="shopping-total">
                        Total: <span id="editShoppingTotal">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Catatan Tambahan</label>
            <textarea id="editNotes" placeholder="Catatan lainnya..."></textarea>
        </div>

        <div class="form-group">
            <label>Tanggal & Waktu</label>
            <input type="datetime-local" id="editDatetime">
        </div>

        <div class="form-group">
            <label>Foto Struk/Bukti (Max 20MB)</label>
            <div class="photo-upload" onclick="document.getElementById('editPhotoInput').click()">
                <input type="file" id="editPhotoInput" accept="image/*" onchange="previewEditPhoto(event)">
                <div id="editPhotoUploadText">üì∑ Klik untuk upload foto baru</div>
                <img id="editPhotoPreview" class="photo-preview" style="display:none">
                <div id="editPhotoInfo" class="photo-info"></div>
            </div>
            <button type="button" class="btn-delete" onclick="clearEditPhoto()" style="margin-top: 10px; font-size: 13px; padding: 8px;">Hapus Foto</button>
        </div>

        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmEditTransaction()">üíæ Simpan Perubahan</button>
            <button class="btn-clear" onclick="closeEditDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="addProductDialog">
        <h3>‚ûï Tambah Produk</h3>
        <div class="form-group">
            <label>Nama Produk *</label>
            <input type="text" id="productName" placeholder="Contoh: Beras Premium">
        </div>
        <div class="form-group">
            <label>Harga (Rp) *</label>
            <input type="text" id="productPrice" placeholder="50000" oninput="formatAmountInput(this)">
        </div>
        <div class="form-group">
            <label>Stok *</label>
            <input type="number" id="productStock" placeholder="100" min="0">
        </div>
        <div class="form-group">
            <label>Deskripsi (Opsional)</label>
            <textarea id="productDescription" placeholder="Deskripsi produk..."></textarea>
        </div>
        <div class="form-group">
            <label>Foto Produk (Opsional, Max 20MB)</label>
            <div class="photo-upload" onclick="document.getElementById('productPhotoInput').click()">
                <input type="file" id="productPhotoInput" accept="image/*" onchange="previewProductPhoto(event)">
                <div id="productPhotoUploadText">üì∑ Klik untuk upload foto</div>
                <img id="productPhotoPreview" class="photo-preview" style="display:none">
                <div id="productPhotoInfo" class="photo-info"></div>
            </div>
        </div>
        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmAddProduct()">üíæ Simpan</button>
            <button class="btn-clear" onclick="closeAddProductDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="editProductDialog">
        <h3>‚úèÔ∏è Edit Produk</h3>
        <div class="form-group">
            <label>Nama Produk *</label>
            <input type="text" id="editProductName">
        </div>
        <div class="form-group">
            <label>Harga (Rp) *</label>
            <input type="text" id="editProductPrice" oninput="formatAmountInput(this)">
        </div>
        <div class="form-group">
            <label>Stok *</label>
            <input type="number" id="editProductStock" min="0">
        </div>
        <div class="form-group">
            <label>Deskripsi (Opsional)</label>
            <textarea id="editProductDescription"></textarea>
        </div>
        <div class="form-group">
            <label>Foto Produk (Opsional, Max 20MB)</label>
            <div class="photo-upload" onclick="document.getElementById('editProductPhotoInput').click()">
                <input type="file" id="editProductPhotoInput" accept="image/*" onchange="previewEditProductPhoto(event)">
                <div id="editProductPhotoUploadText">üì∑ Klik untuk upload foto baru</div>
                <img id="editProductPhotoPreview" class="photo-preview" style="display:none">
                <div id="editProductPhotoInfo" class="photo-info"></div>
            </div>
            <button type="button" class="btn-delete" onclick="clearEditProductPhoto()" style="margin-top: 10px; font-size: 13px; padding: 8px;">Hapus Foto</button>
        </div>
        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmEditProduct()">üíæ Simpan</button>
            <button class="btn-clear" onclick="closeEditProductDialog()">Batal</button>
        </div>
    </div>

    <div class="modal-dialog" id="addStockDialog">
        <h3>üì¶ Tambah Stok Produk</h3>
        <div class="form-group">
            <label id="addStockProductName" style="font-size: 16px; color: #667eea; margin-bottom: 10px;"></label>
        </div>
        <div class="form-group">
            <label>Stok Saat Ini</label>
            <input type="number" id="currentStockDisplay" disabled style="background: #f0f0f0;">
        </div>
        <div class="form-group">
            <label>Tambah Stok Sebanyak</label>
            <input type="number" id="addStockAmount" min="1" value="1" placeholder="Jumlah yang akan ditambahkan">
        </div>
        <div style="background: #f9fafb; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 5px;">Stok Setelah Ditambah:</div>
            <div id="newStockDisplay" style="color: #10b981; font-size: 20px; font-weight: bold;">0</div>
        </div>
        <div class="modal-dialog-buttons">
            <button class="btn-income" onclick="confirmAddStock()">‚úì Tambah Stok</button>
            <button class="btn-clear" onclick="closeAddStockDialog()">Batal</button>
        </div>
    </div>

    <input type="file" id="importData" accept=".json" style="display:none" onchange="showImportDialog(event)">

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingText">Memproses...</h3>
            <p style="color: #666; margin-top: 10px;">Mohon tunggu, jangan tutup halaman</p>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'financeTransactions';
        const PROFILE_KEY = 'userProfile';
        const PRODUCTS_KEY = 'shopProducts';
        
        let transactions = [];
        let products = [];
        let userProfile = {};
        let pendingAction = null;
        
        let currentPeriod = 'day';
        let currentPhotoData = null;
        let currentPaymentPhotoData = null;
        let currentProductPhotoData = null;
        let currentEditProductPhotoData = null;
        let dateMode = 'auto';
        let inputMode = 'quick';
        let realtimeInterval;
        let currentDebtIndex = null;
        let selectedYear = new Date().getFullYear();
        let selectedMonth = 'all';
        let currentHistoryPeriod = 'all';
        let selectedHistoryYear = new Date().getFullYear();
        let selectedHistoryMonth = 'all';
        let pendingImportData = null;
        let editInputMode = 'quick';
        let currentEditIndex = null;
        let currentEditPhotoData = null;
        let currentSearchTerm = '';
        let currentFilter = 'all';
        let incomeExpanded = false;
        let expenseExpanded = false;
        let debtExpanded = false;
        let receivableExpanded = false;
        let incomeFilter = { sort: 'date-desc', minAmount: '', maxAmount: '' };
        let expenseFilter = { sort: 'date-desc', minAmount: '', maxAmount: '' };
        let debtFilter = { sort: 'date-desc', minAmount: '', maxAmount: '', dueDate: 'all', status: 'all' };
        let receivableFilter = { sort: 'date-desc', minAmount: '', maxAmount: '', dueDate: 'all', status: 'all' };
        let productSearchTerm = '';
        let productFilterMode = 'newest';
		let productsExpanded = false;
        let notificationFilters = {
            price: 'all',
            time: 'all',
            type: 'all'
        };

        let mainMode = 'transaction';
        let directSaleItems = [];
        let currentEditProductIndex = null;
        let currentAddStockProductIndex = null;

        async function compressImage(file, maxSizeMB = 5) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        const maxDimension = 1920;
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        let quality = 0.9;
                        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        while (compressedDataUrl.length > maxSizeMB * 1024 * 1024 * 1.37 && quality > 0.1) {
                            quality -= 0.1;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function previewPhoto(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20000000) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 20MB.');
                    event.target.value = '';
                    return;
                }
                
                try {
                    showLoadingOverlay('Mengkompresi gambar...');
                    const compressedDataUrl = await compressImage(file, 5);
                    currentPhotoData = compressedDataUrl;
                    
                    const preview = document.getElementById('photoPreview');
                    const text = document.getElementById('photoUploadText');
                    const info = document.getElementById('photoInfo');
                    
                    preview.src = currentPhotoData;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    
                    const compressedSize = (compressedDataUrl.length * 0.75) / 1024;
                    info.textContent = `‚úì ${file.name} (Terkompresi: ${compressedSize.toFixed(1)} KB)`;
                    
                    hideLoadingOverlay();
                } catch (error) {
                    hideLoadingOverlay();
                    alert('‚ùå Gagal memproses gambar!');
                    event.target.value = '';
                }
            }
        }

        async function previewPaymentPhoto(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20000000) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 20MB.');
                    event.target.value = '';
                    return;
                }
                
                try {
                    showLoadingOverlay('Mengkompresi gambar...');
                    const compressedDataUrl = await compressImage(file, 5);
                    currentPaymentPhotoData = compressedDataUrl;
                    
                    const preview = document.getElementById('paymentPhotoPreview');
                    const text = document.getElementById('paymentPhotoUploadText');
                    const info = document.getElementById('paymentPhotoInfo');
                    
                    preview.src = currentPaymentPhotoData;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    
                    const compressedSize = (compressedDataUrl.length * 0.75) / 1024;
                    info.textContent = `‚úì ${file.name} (Terkompresi: ${compressedSize.toFixed(1)} KB)`;
                    
                    hideLoadingOverlay();
                } catch (error) {
                    hideLoadingOverlay();
                    alert('‚ùå Gagal memproses gambar!');
                    event.target.value = '';
                }
            }
        }

        async function previewProductPhoto(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20000000) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 20MB.');
                    event.target.value = '';
                    return;
                }
                
                try {
                    showLoadingOverlay('Mengkompresi gambar...');
                    const compressedDataUrl = await compressImage(file, 5);
                    currentProductPhotoData = compressedDataUrl;
                    
                    const preview = document.getElementById('productPhotoPreview');
                    const text = document.getElementById('productPhotoUploadText');
                    const info = document.getElementById('productPhotoInfo');
                    
                    preview.src = currentProductPhotoData;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    
                    const compressedSize = (compressedDataUrl.length * 0.75) / 1024;
                    info.textContent = `‚úì ${file.name} (Terkompresi: ${compressedSize.toFixed(1)} KB)`;
                    
                    hideLoadingOverlay();
                } catch (error) {
                    hideLoadingOverlay();
                    alert('‚ùå Gagal memproses gambar!');
                    event.target.value = '';
                }
            }
        }

        async function previewEditProductPhoto(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20000000) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 20MB.');
                    event.target.value = '';
                    return;
                }
                
                try {
                    showLoadingOverlay('Mengkompresi gambar...');
                    const compressedDataUrl = await compressImage(file, 5);
                    currentEditProductPhotoData = compressedDataUrl;
                    
                    const preview = document.getElementById('editProductPhotoPreview');
                    const text = document.getElementById('editProductPhotoUploadText');
                    const info = document.getElementById('editProductPhotoInfo');
                    
                    preview.src = currentEditProductPhotoData;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    
                    const compressedSize = (compressedDataUrl.length * 0.75) / 1024;
                    info.textContent = `‚úì ${file.name} (Terkompresi: ${compressedSize.toFixed(1)} KB)`;
                    
                    hideLoadingOverlay();
                } catch (error) {
                    hideLoadingOverlay();
                    alert('‚ùå Gagal memproses gambar!');
                    event.target.value = '';
                }
            }
        }

        async function previewEditPhoto(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const file = event.target.files[0];
            if (file) {
                if (file.size > 20000000) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 20MB.');
                    event.target.value = '';
                    return;
                }
                
                try {
                    showLoadingOverlay('Mengkompresi gambar...');
                    const compressedDataUrl = await compressImage(file, 5);
                    currentEditPhotoData = compressedDataUrl;
                    
                    const preview = document.getElementById('editPhotoPreview');
                    const text = document.getElementById('editPhotoUploadText');
                    const info = document.getElementById('editPhotoInfo');
                    
                    preview.src = currentEditPhotoData;
                    preview.style.display = 'block';
                    text.style.display = 'none';
                    
                    const compressedSize = (compressedDataUrl.length * 0.75) / 1024;
                    info.textContent = `‚úì ${file.name} (Terkompresi: ${compressedSize.toFixed(1)} KB)`;
                    
                    hideLoadingOverlay();
                } catch (error) {
                    hideLoadingOverlay();
                    alert('‚ùå Gagal memproses gambar!');
                    event.target.value = '';
                }
            }
        }

        function loadUserProfile() {
            try {
                const data = localStorage.getItem(PROFILE_KEY);
                const profile = data ? JSON.parse(data) : {};
                userProfile = profile;
                updateProfileDisplay();
            } catch (error) {
                console.error('Error loading profile:', error);
                userProfile = {};
                updateProfileDisplay();
            }
        }

        function updateProfileDisplay() {
            document.getElementById('displayUserName').textContent = userProfile.name || '-';
            document.getElementById('displayBusinessName').textContent = userProfile.businessName || '-';
            document.getElementById('displayAddress').textContent = userProfile.address || '-';
            document.getElementById('displayAdditionalInfo').textContent = userProfile.additionalInfo || '-';
        }

        function showProfileDialog() {
            closeSettingsDialog();
            document.getElementById('profileUserName').value = userProfile.name || '';
            document.getElementById('profileBusinessName').value = userProfile.businessName || '';
            document.getElementById('profileAddress').value = userProfile.address || '';
            document.getElementById('profileAdditionalInfo').value = userProfile.additionalInfo || '';
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('profileDialog').style.display = 'block';
        }

        function closeProfileDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('profileDialog').style.display = 'none';
        }

        function confirmProfileSave() {
            const name = document.getElementById('profileUserName').value.trim();
            
            if (!name) {
                alert('Nama tidak boleh kosong!');
                return;
            }

            userProfile = {
                name: name,
                businessName: document.getElementById('profileBusinessName').value.trim(),
                address: document.getElementById('profileAddress').value.trim(),
                additionalInfo: document.getElementById('profileAdditionalInfo').value.trim()
            };

            try {
                localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
                updateProfileDisplay();
                closeProfileDialog();
                alert('‚úÖ Profil berhasil disimpan!');
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('‚ùå Gagal menyimpan profil!');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                let transactions = data ? JSON.parse(data) : [];
        
                // PERBAIKAN: Tambahkan ID untuk transaksi lama yang belum punya ID
                let needSave = false;
                transactions = transactions.map(t => {
                    if (!t.id) {
                        needSave = true;
                        return {
                            ...t,
                            id: t.timestamp + '-' + Math.random().toString(36).substr(2, 9)
                        };
                    }
                    return t;
                });
        
                // Auto-save jika ada transaksi yang ditambahkan ID
                if (needSave) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                    console.log('‚úÖ Migration: Added IDs to', transactions.length, 'transactions');
                }
        
                return transactions;
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }

        function saveToStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                updateStorageInfo(true);
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('‚ö†Ô∏è Penyimpanan browser penuh! Silakan hapus beberapa data lama atau export data Anda.');
                }
                updateStorageInfo(false);
                return false;
            }
        }

        function updateStorageInfo(success) {
            const info = document.getElementById('storageInfo');
            if (success) {
                info.innerHTML = '‚úì Data tersimpan otomatis di browser';
                info.style.background = '#eef2ff';
                info.style.color = '#667eea';
            } else {
                info.innerHTML = '‚ö† Gagal menyimpan data';
                info.style.background = '#fee';
                info.style.color = '#e44';
            }
        }

        function toggleDebtSection() {
            const type = document.getElementById('type').value;
            const debtSection = document.getElementById('debtSection');
            const debtLabel = document.getElementById('debtLabel');
            const debtTypeLabel = document.getElementById('debtTypeLabel');
            const debtTypeSelect = document.getElementById('debtType');

            if (type === 'debt') {
                debtSection.classList.remove('hidden');
                debtLabel.textContent = 'Hutang kepada siapa / di mana?';
                debtTypeLabel.textContent = 'Jenis Hutang';
                document.getElementById('debtPerson').placeholder = 'Contoh: Bank BRI, Toko Maju';
        
                debtTypeSelect.innerHTML = `
                    <option value="money">Pinjaman Uang (Mendapat Uang Pinjaman)</option>
                    <option value="goods">Barang/Jasa (Beli Jasa/Barang Belum Dibayar)</option>
                `;
            } else if (type === 'receivable') {
                debtSection.classList.remove('hidden');
                debtLabel.textContent = 'Piutang dari siapa?';
                debtTypeLabel.textContent = 'Jenis Piutang';
                document.getElementById('debtPerson').placeholder = 'Contoh: Budi, Toko Jaya';
        
                debtTypeSelect.innerHTML = `
                    <option value="money">Pinjaman Uang (Memberikan Pinjaman Uang)</option>
                    <option value="goods">Barang/Jasa (Jual Jasa/Barang Belum Dibayar)</option>
                `;
            } else {
                debtSection.classList.add('hidden');
            }
        }

        function toggleInterestFields() {
            const hasInterest = document.getElementById('hasInterest').checked;
            const fields = document.getElementById('interestFields');
    
            if (hasInterest) {
                fields.classList.remove('hidden');
                calculateInterestPreview();
            } else {
                fields.classList.add('hidden');
            }
        }

        function formatInterestInput(input) {
            let value = input.value;
            value = value.replace(/[^0-9,\.]/g, '');
            value = value.replace(/,/g, '.');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            input.value = value;
        }

        function parseInterestRate(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleaned = value.replace(/,/g, '.');
                return parseFloat(cleaned) || 0;
            }
            return 0;
        }

        function calculateInterestPreview() {
            const amountInput = inputMode === 'quick' ? 
                document.getElementById('quickAmount').value : 
                document.getElementById('shoppingTotal').textContent.replace('Rp ', '');
    
            const amount = parseAmount(amountInput);
            const rateInput = document.getElementById('interestRate').value;
            const rate = parseInterestRate(rateInput);
            const period = document.getElementById('interestPeriod').value;
    
            if (amount <= 0 || rate <= 0) {
                document.getElementById('interestPreview').textContent = 'Isi nominal dan bunga untuk melihat preview';
                return;
            }
    
            const interest = (amount * rate) / 100;
            const total = amount + interest;
    
            let periodText = '';
            if (period === 'day') periodText = 'per hari';
            else if (period === 'week') periodText = 'per minggu';
            else if (period === 'month') periodText = 'per bulan';
            else if (period === 'year') periodText = 'per tahun';
    
            document.getElementById('interestPreview').innerHTML = `
                Pokok: ${formatCurrency(amount)}<br>
                Bunga ${rate}% ${periodText}: ${formatCurrency(interest)}<br>
                <strong>Total ${periodText}: ${formatCurrency(total)}</strong>
            `;
        }

        function setInputMode(mode) {
            inputMode = mode;
            const quickBtn = document.getElementById('quickModeBtn');
            const detailBtn = document.getElementById('detailModeBtn');
            const quickDiv = document.getElementById('quickMode');
            const detailDiv = document.getElementById('detailMode');
        
            if (mode === 'quick') {
                quickBtn.classList.add('active');
                detailBtn.classList.remove('active');
                quickDiv.classList.remove('hidden');
                detailDiv.classList.add('hidden');
            } else {
                quickBtn.classList.remove('active');
                detailBtn.classList.add('active');
                quickDiv.classList.add('hidden');
                detailDiv.classList.remove('hidden');
                
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemQty').value = '1';
                document.getElementById('shoppingTotal').textContent = 'Rp 0';
            }
        }

        function calculateDetailTotal() {
            const priceInput = document.getElementById('itemPrice').value;
            const price = parseAmount(priceInput);
            const qty = parseInt(document.getElementById('itemQty').value) || 1;
    
            const total = price * qty;
            document.getElementById('shoppingTotal').textContent = formatCurrency(total);
    
            // TAMBAHKAN INI
            if (document.getElementById('hasInterest') && document.getElementById('hasInterest').checked) {
                calculateInterestPreview();
            }
        }

        function setDateMode(mode) {
            dateMode = mode;
            const autoBtn = document.getElementById('autoDateBtn');
            const manualBtn = document.getElementById('manualDateBtn');
            const autoDisplay = document.getElementById('autoDateDisplay');
            const manualInput = document.getElementById('manualDateInput');

            if (mode === 'auto') {
                autoBtn.classList.add('active');
                manualBtn.classList.remove('active');
                autoDisplay.classList.remove('hidden');
                manualInput.classList.add('hidden');
                
                startRealtimeUpdate();
            } else {
                autoBtn.classList.remove('active');
                manualBtn.classList.add('active');
                autoDisplay.classList.add('hidden');
                manualInput.classList.remove('hidden');
                
                stopRealtimeUpdate();
                setDefaultManualDateTime();
            }
        }

        function startRealtimeUpdate() {
            updateRealtimeDisplay();
            realtimeInterval = setInterval(updateRealtimeDisplay, 1000);
        }

        function stopRealtimeUpdate() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
            }
        }

        function updateRealtimeDisplay() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('autoDateText').textContent = 
                now.toLocaleDateString('id-ID', options);
        }

        function setDefaultManualDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('manualDatetime').value = 
                `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function getCurrentDateTime() {
            if (dateMode === 'auto') {
                return new Date().toISOString();
            } else {
                const manualValue = document.getElementById('manualDatetime').value;
                if (!manualValue) {
                    alert('Silakan isi tanggal dan waktu!');
                    return null;
                }
                return parseDateTimeManual(manualValue);
            }
        }

        function formatAmountInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
            }
            input.value = value;
        }

        function parseAmount(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleaned = value.replace(/\D/g, '');
                return parseInt(cleaned) || 0;
            }
            return 0;
        }

        function parseDateTimeManual(datetimeInput) {
            const date = new Date(datetimeInput);
            return date.toISOString();
        }

        function clearPhotoPreview() {
            currentPhotoData = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoUploadText').style.display = 'block';
            document.getElementById('photoInfo').textContent = '';
            document.getElementById('photoInput').value = '';
        }

        function clearPaymentPhotoPreview() {
            currentPaymentPhotoData = null;
            document.getElementById('paymentPhotoPreview').style.display = 'none';
            document.getElementById('paymentPhotoUploadText').style.display = 'block';
            document.getElementById('paymentPhotoInfo').textContent = '';
            document.getElementById('paymentPhotoInput').value = '';
        }

        function clearEditPhoto() {
            if (currentEditIndex !== null) {
                transactions[currentEditIndex].photo = null;
            }
            currentEditPhotoData = null;
            document.getElementById('editPhotoPreview').style.display = 'none';
            document.getElementById('editPhotoUploadText').style.display = 'block';
            document.getElementById('editPhotoInfo').textContent = '';
            document.getElementById('editPhotoInput').value = '';
        }

        function clearProductPhotoPreview() {
            currentProductPhotoData = null;
            document.getElementById('productPhotoPreview').style.display = 'none';
            document.getElementById('productPhotoUploadText').style.display = 'block';
            document.getElementById('productPhotoInfo').textContent = '';
            document.getElementById('productPhotoInput').value = '';
        }

        function clearEditProductPhoto() {
            if (currentEditProductIndex !== null) {
                products[currentEditProductIndex].photo = null;
            }
            currentEditProductPhotoData = null;
            document.getElementById('editProductPhotoPreview').style.display = 'none';
            document.getElementById('editProductPhotoUploadText').style.display = 'block';
            document.getElementById('editProductPhotoInfo').textContent = '';
            document.getElementById('editProductPhotoInput').value = '';
        }

        function showPhotoModal(photoData) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = photoData;
        }

        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }

        function updateCurrentDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentDateTime').textContent = 
                now.toLocaleDateString('id-ID', options);
        }

        setInterval(updateCurrentDateTime, 1000);
        setInterval(updateNotificationBadge, 60000);
        updateCurrentDateTime();

        function formatCurrency(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        function handleTransactionSubmit(e) {
            e.preventDefault();

            const datetime = getCurrentDateTime();
            if (!datetime) return;

            const type = document.getElementById('type').value;
            let finalAmount = 0;
            let finalDescription = '';
            let notes = document.getElementById('notes').value;
            let isDetailed = false;
            let detailedPrice = 0;
            let detailedQty = 1;

            if (inputMode === 'quick') {
                const amountInput = document.getElementById('quickAmount').value;
                finalAmount = parseAmount(amountInput);
                finalDescription = document.getElementById('quickDescription').value;
            } else {
                const priceInput = document.getElementById('itemPrice').value;
                const price = parseAmount(priceInput);
                const qty = parseInt(document.getElementById('itemQty').value) || 1;
        
                if (price <= 0) {
                    alert('Mohon isi harga satuan!');
                    return;
                }
        
                finalAmount = price * qty;
                finalDescription = document.getElementById('detailDescription').value;
                isDetailed = true;
                detailedPrice = price;
                detailedQty = qty;
            }

            if (finalAmount <= 0) {
                alert('Jumlah harus lebih dari 0!');
                return;
            }

            if (!finalDescription) {
                alert('Mohon isi deskripsi transaksi!');
                return;
            }

            let debtPerson = '';
            let debtDueDate = '';
            let debtType = 'money';
            let hasInterest = false;
            let interestRate = 0;
            let interestPeriod = 'month';

            if (type === 'debt' || type === 'receivable') {
                debtPerson = document.getElementById('debtPerson').value.trim();
                debtDueDate = document.getElementById('debtDueDate').value;
                debtType = document.getElementById('debtType').value;
                hasInterest = document.getElementById('hasInterest').checked;
    
                if (hasInterest) {
                    const rateInput = document.getElementById('interestRate').value;
                    interestRate = parseInterestRate(rateInput);
                    interestPeriod = document.getElementById('interestPeriod').value;
        
                    if (interestRate <= 0) {
                        alert('Mohon isi persentase bunga!');
                        return;
                    }
                }

                const existingDebt = transactions.find(t => 
                    t.type === type && 
                    t.debtPerson && 
                    t.debtPerson.toLowerCase() === debtPerson.toLowerCase() && 
                    !t.isPaid
                );

                if (existingDebt && debtPerson) {
                    if (confirm(`Sudah ada ${type === 'debt' ? 'hutang' : 'piutang'} dengan "${debtPerson}" sebesar ${formatCurrency(getRemainingDebt(existingDebt))}.\n\nTambahkan ke ${type === 'debt' ? 'hutang' : 'piutang'} yang sudah ada?`)) {
                        if (!existingDebt.payments) {
                            existingDebt.payments = [];
                        }
                        existingDebt.amount += finalAmount;
                
                        existingDebt.payments.push({
                            amount: -finalAmount,
                            note: `Penambahan ${type === 'debt' ? 'hutang' : 'piutang'}: ${finalDescription}`,
                            date: datetime,
                            isAddition: true,
                            photo: currentPhotoData
                        });

                        const saved = saveToStorage(transactions);
                        if (!saved) return;
                
                        // PERBAIKAN: Force refresh semua tampilan
                        forceRefreshAllDisplays();
                
                        // Clear form
                        document.getElementById('quickAmount').value = '';
                        document.getElementById('quickDescription').value = '';
                        document.getElementById('detailDescription').value = '';
                        document.getElementById('itemPrice').value = '';
                        document.getElementById('itemQty').value = '1';
                        document.getElementById('notes').value = '';
                        document.getElementById('debtPerson').value = '';
                        document.getElementById('debtDueDate').value = '';
						document.getElementById('debtType').value = 'money';
						document.getElementById('hasInterest').checked = false;
						document.getElementById('interestRate').value = '';
						document.getElementById('interestPeriod').value = 'month';
						toggleInterestFields();
                
                        if (dateMode === 'manual') {
                            setDefaultManualDateTime();
                        }
                
                        clearPhotoPreview();
                        calculateDetailTotal();
                
                        alert(`‚úÖ Berhasil menambah ${type === 'debt' ? 'hutang' : 'piutang'} sebesar ${formatCurrency(finalAmount)}!\n\nTotal ${type === 'debt' ? 'hutang' : 'piutang'} sekarang: ${formatCurrency(getRemainingDebt(existingDebt))}`);
                        return;
                    }
                }
            }

            const transaction = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: type,
                amount: finalAmount,
                description: finalDescription,
                notes: notes,
                isDetailed: isDetailed,
                detailedPrice: detailedPrice,
                detailedQty: detailedQty,
                datetime: datetime,
                photo: currentPhotoData,
                timestamp: new Date().getTime(),
                isPaid: false,
                payments: [],
                debtPerson: debtPerson,
                debtDueDate: debtDueDate ? parseDateTimeManual(debtDueDate) : '',
                debtType: debtType,
                hasInterest: hasInterest,
                interestRate: interestRate,
                interestPeriod: interestPeriod
            };

            // Jika hutang/piutang tipe UANG, buat transaksi linked
            if (type === 'debt' && debtType === 'money') {
                const linkedIncome = {
                    id: Date.now() + 1 + '-' + Math.random().toString(36).substr(2, 9),
                    type: 'income',
                    amount: finalAmount,
                    description: `Pinjaman dari ${debtPerson || 'Tidak disebutkan'}`,
                    notes: `Terkait hutang: ${finalDescription}`,
                    isDetailed: false,
                    detailedPrice: 0,
                    detailedQty: 1,
                    datetime: datetime,
                    photo: null,
                    timestamp: new Date().getTime()
                };
                transactions.push(linkedIncome);
            } else if (type === 'receivable' && debtType === 'money') {
                const linkedExpense = {
                    id: Date.now() + 1 + '-' + Math.random().toString(36).substr(2, 9),
                    type: 'expense',
                    amount: finalAmount,
                    description: `Pinjaman ke ${debtPerson || 'Tidak disebutkan'}`,
                    notes: `Terkait piutang: ${finalDescription}`,
                    isDetailed: false,
                    detailedPrice: 0,
                    detailedQty: 1,
                    datetime: datetime,
                    photo: null,
                    timestamp: new Date().getTime()
                };
                transactions.push(linkedExpense);
            }

            transactions.push(transaction);
            const saved = saveToStorage(transactions);
            if (!saved) {
                transactions.pop();
                return;
            }

            // Clear form
            document.getElementById('quickAmount').value = '';
            document.getElementById('quickDescription').value = '';
            document.getElementById('detailDescription').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('notes').value = '';
            document.getElementById('debtPerson').value = '';
            document.getElementById('debtDueDate').value = '';
			document.getElementById('debtType').value = 'money';
            document.getElementById('hasInterest').checked = false;
            document.getElementById('interestRate').value = '';
            document.getElementById('interestPeriod').value = 'month';
            toggleInterestFields();
    
            if (dateMode === 'manual') {
                setDefaultManualDateTime();
            }
    
            clearPhotoPreview();
            calculateDetailTotal();

            // PERBAIKAN: Force refresh semua tampilan
            forceRefreshAllDisplays();

            alert('‚úÖ Transaksi berhasil ditambahkan!');
        }

        function getRemainingDebt(transaction) {
            if (!transaction.payments || transaction.payments.length === 0) {
                return transaction.amount;
            }
            
            const totalPaid = transaction.payments.reduce((sum, payment) => {
                return sum + (payment.isAddition ? payment.amount : -payment.amount);
            }, 0);
            
            const remaining = transaction.amount + totalPaid;
            // PERBAIKAN: Bulatkan ke 2 desimal untuk menghindari floating point error
            return Math.round(remaining * 100) / 100;
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('open');
        }

        function filterNotifications() {
            notificationFilters.price = document.getElementById('notificationPriceFilter').value;
            notificationFilters.time = document.getElementById('notificationTimeFilter').value;
            notificationFilters.type = document.getElementById('notificationTypeFilter').value;
            displayNotifications();
        }

        function updateNotificationBadge() {
            const now = new Date();
            let count = 0;
            
            transactions.forEach(t => {
                if ((t.type === 'debt'|| t.type === 'receivable') && !t.isPaid && t.debtDueDate) {
                    const dueDate = new Date(t.debtDueDate);
                    const diffHours = (dueDate - now) / (1000 * 60 * 60);
                    
                    if (diffHours < 0 || diffHours <= 168) {
                        count++;
                    }
                }
            });
            
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            displayNotifications();
        }

        function showPaymentDialog(index) {
            // PERBAIKAN KRITIS: Set currentDebtIndex PERTAMA sebelum operasi lain
            currentDebtIndex = index;
    
            // Validasi index
            if (index === null || index === undefined || index < 0 || index >= transactions.length) {
                alert('‚ùå Transaksi tidak valid!');
                return;
            }
    
            // Ambil data transaksi FRESH dari array
            const transaction = transactions[index];
    
            // Validasi transaksi exists
            if (!transaction) {
                alert('‚ùå Transaksi tidak ditemukan!');
                return;
            }
    
            // Reset SEMUA field input ke kondisi awal
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNote').value = '';
            document.getElementById('paymentNextDueDate').value = '';
    
            // Clear preview foto lama
            clearPaymentPhotoPreview();
    
            // Hitung sisa hutang/piutang REAL-TIME
            const remaining = getRemainingDebt(transaction);
    
            // Update display
            document.getElementById('remainingAmount').textContent = formatCurrency(remaining);
    
            // Set title berdasarkan tipe
            const title = transaction.type === 'debt' ? 'üíµ Bayar Cicilan Hutang' : 'üí∞ Terima Pembayaran Piutang';
            document.getElementById('paymentTitle').textContent = title;
    
            // Show dialog
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('paymentDialog').style.display = 'block';
    
            // Debug log untuk tracking
            console.log('Payment dialog opened for index:', index);
            console.log('Transaction:', transaction.description);
            console.log('Remaining:', remaining);
            console.log('currentDebtIndex set to:', currentDebtIndex);
        }

        function closePaymentDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('paymentDialog').style.display = 'none';
    
            // RESET currentDebtIndex untuk mencegah bug
            currentDebtIndex = null;
    
            // Clear foto preview
            clearPaymentPhotoPreview();
    
            // Reset input fields
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNote').value = '';
            document.getElementById('paymentNextDueDate').value = '';
    
            console.log('Payment dialog closed, currentDebtIndex reset to null');
        }

        function confirmPayment(isPaidFull = false) {
            // PERBAIKAN: Simpan index di variabel lokal untuk menghindari race condition
            const debtIndex = currentDebtIndex;
    
            if (debtIndex === null || debtIndex === undefined) {
                alert('‚ùå Error: Index transaksi tidak valid!');
                console.error('currentDebtIndex is null/undefined');
                return;
            }

            if (debtIndex < 0 || debtIndex >= transactions.length) {
                alert('‚ùå Error: Transaksi tidak ditemukan!');
                console.error('currentDebtIndex out of range:', currentDebtIndex);
                return;
            }

            const transaction = transactions[debtIndex];

            if (!transaction) {
                alert('‚ùå Error: Data transaksi tidak ditemukan!');
                console.error('Transaction not found at index:', currentDebtIndex);
                return;
            }

            const remaining = getRemainingDebt(transaction);
            let paymentAmount = 0;

            if (isPaidFull) {
                paymentAmount = remaining;
            } else {
                const inputAmount = document.getElementById('paymentAmount').value;
                paymentAmount = parseAmount(inputAmount);

                if (paymentAmount <= 0) {
                    alert('Jumlah pembayaran harus lebih dari 0!');
                    return;
                }

                if (paymentAmount > remaining) {
                    alert(`Jumlah pembayaran tidak boleh melebihi sisa hutang/piutang (${formatCurrency(remaining)})!`);
                    return;
                }
            }

            const note = document.getElementById('paymentNote').value || (isPaidFull ? 'Pelunasan' : 'Cicilan');
            const nextDueDateValue = document.getElementById('paymentNextDueDate').value;

            const payment = {
                amount: paymentAmount,
                note: note,
                date: new Date().toISOString(),
                photo: currentPaymentPhotoData || null,
                isAddition: false
            };

            if (!transaction.payments) {
                transaction.payments = [];
            }

            transaction.payments.push(payment);

            const newRemaining = getRemainingDebt(transaction);

            if (Math.abs(newRemaining) < 0.01 || isPaidFull) {
                transaction.isPaid = true;
                transaction.paidDate = new Date().toISOString();
            } else if (nextDueDateValue) {
                transaction.debtDueDate = parseDateTimeManual(nextDueDateValue);
            }

            const linkedTransaction = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9), 
				type: transaction.type === 'debt' ? 'expense' : 'income',
                amount: paymentAmount,
                description: `${note} - ${transaction.description}`,
                notes: `Pembayaran ${transaction.type === 'debt' ? 'hutang kepada' : 'piutang dari'} ${transaction.debtPerson || 'Tidak disebutkan'}`,
                isDetailed: false,
                detailedPrice: 0,
                detailedQty: 1,
                datetime: new Date().toISOString(),
                photo: currentPaymentPhotoData || null,
                timestamp: Date.now()
            };

            transactions.push(linkedTransaction);

            saveToStorage(transactions);

            // Tutup dialog dulu
            closePaymentDialog();

            // PERBAIKAN: Delay sebentar lalu force refresh
            setTimeout(() => {
                forceRefreshAllDisplays();

                // Show success message
                if (transaction.isPaid) {
                    alert(`‚úÖ Pembayaran berhasil! ${transaction.type === 'debt' ? 'Hutang' : 'Piutang'} telah LUNAS!`);
                } else {
                    alert(`‚úÖ Cicilan berhasil dicatat! Sisa: ${formatCurrency(newRemaining)}`);
                }
            }, 100);
        }

        function showPaymentHistory(index) {
            const transaction = transactions[index];
            
            if (!transaction.payments || transaction.payments.length === 0) {
                alert('Belum ada riwayat pembayaran');
                return;
            }
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${transaction.description}</div>
                    <div style="color: #666; font-size: 14px;">Total: ${formatCurrency(transaction.amount)}</div>
                    <div style="color: #666; font-size: 14px;">Sisa: ${formatCurrency(getRemainingDebt(transaction))}</div>
                </div>
            `;
            
            transaction.payments.forEach((payment, idx) => {
                const date = new Date(payment.date);
                const dateStr = date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${payment.isAddition ? '#f59e0b' : '#10b981'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600;">${payment.isAddition ? '‚ûï Penambahan' : 'üí∞ Pembayaran'} #${idx + 1}</span>
                            <span style="font-weight: bold; color: ${payment.isAddition ? '#f59e0b' : '#10b981'};">${formatCurrency(Math.abs(payment.amount))}</span>
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            <div>üìÖ ${dateStr}</div>
                            ${payment.note ? `<div>üìù ${payment.note}</div>` : ''}
                        </div>
                        ${payment.photo ? `
                            <div style="margin-top: 10px;">
                                <img src="${payment.photo}" style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal('${payment.photo}')">
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            document.getElementById('historyContent').innerHTML = html;
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('historyDialog').style.display = 'block';
        }

        function closeHistoryDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('historyDialog').style.display = 'none';
        }

        function displayNotifications() {
            const now = new Date();
            let items = [];
            
            transactions.forEach((t, index) => {
                if ((t.type === 'debt' || t.type === 'receivable') && !t.isPaid && t.debtDueDate) {
                    const dueDate = new Date(t.debtDueDate);
                    const diffMs = dueDate - now;
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    const remaining = getRemainingDebt(t);
                    
                    let timeCategory = '';
                    if (diffMs < 0) {
                        timeCategory = 'overdue';
                    } else if (diffHours <= 24) {
                        timeCategory = 'today';
                    } else if (diffHours <= 168) {
                        timeCategory = 'week';
                    }
                    
                    if (timeCategory && (diffMs < 0 || diffHours <= 168)) {
                        const absMinutes = Math.abs(diffMinutes);
                        const absHours = Math.floor(absMinutes / 60);
                        const absDays = Math.floor(absHours / 24);
                        const remainingHours = absHours % 24;
                        const remainingMinutes = absMinutes % 60;
                        
                        items.push({
                            index: index,
                            transaction: t,
                            overdue: diffMs < 0,
                            days: diffMs < 0 ? absDays : diffDays,
                            hours: diffMs < 0 ? remainingHours : (diffHours % 24),
                            minutes: diffMs < 0 ? remainingMinutes : (diffMinutes % 60),
                            remaining: remaining,
                            timeCategory: timeCategory
                        });
                    }
                }
            });
            
            items = items.filter(item => {
                if (notificationFilters.price !== 'all') {
                    if (notificationFilters.price === 'low' && item.remaining >= 100000) return false;
                    if (notificationFilters.price === 'medium' && (item.remaining < 100000 || item.remaining > 1000000)) return false;
                    if (notificationFilters.price === 'high' && item.remaining <= 1000000) return false;
                }
                
                if (notificationFilters.time !== 'all') {
                    if (notificationFilters.time !== item.timeCategory) return false;
                }
                
                if (notificationFilters.type !== 'all') {
                    if (notificationFilters.type !== item.transaction.type) return false;
                }
                
                return true;
            });
            
            const container = document.getElementById('notificationContent');
            
            if (items.length === 0) {
                container.innerHTML = '<p class="no-data">Tidak ada notifikasi yang sesuai filter</p>';
                return;
            }
            
            const overdueItems = items.filter(i => i.overdue);
            const dueSoonItems = items.filter(i => !i.overdue);
            
            let html = '';
            
            if (overdueItems.length > 0) {
                html += '<h4 style="color: #dc2626; margin-bottom: 15px;">‚ö†Ô∏è Sudah Lewat Jatuh Tempo</h4>';
                overdueItems.forEach(item => {
                    const t = item.transaction;
                    const dueDate = new Date(t.debtDueDate);
                    const dueDateStr = dueDate.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let timeText = '';
                    if (item.days > 0) {
                        timeText = `${item.days} hari ${item.hours} jam yang lalu`;
                    } else if (item.hours > 0) {
                        timeText = `${item.hours} jam ${item.minutes} menit yang lalu`;
                    } else {
                        timeText = `${item.minutes} menit yang lalu`;
                    }
                    
                    html += `
                        <div class="notification-item notification-item-overdue">
                            <div class="notification-desc">
                                ${t.type === 'debt' ? 'üí≥' : 'üí∞'} ${t.debtPerson || 'Tidak disebutkan'} - ${t.description}
                            </div>
                            <div class="notification-detail">
                                <div>‚è∞ Jatuh tempo: ${dueDateStr} (${timeText})</div>
                                <div>üíµ Sisa: ${formatCurrency(item.remaining)}</div>
                            </div>
                            <div class="notification-actions">
                                <button class="btn-pay" onclick="toggleNotificationPanel(); showPaymentDialog(${item.index})">üí∞ Bayar</button>
                                <button class="btn-paid-full" onclick="toggleNotificationPanel(); showPaymentDialog(${item.index})">‚úÖ Lunas</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (dueSoonItems.length > 0) {
                html += '<h4 style="color: #f59e0b; margin-top: 20px; margin-bottom: 15px;">‚è∞ Akan Jatuh Tempo</h4>';
                dueSoonItems.forEach(item => {
                    const t = item.transaction;
                    const dueDate = new Date(t.debtDueDate);
                    const dueDateStr = dueDate.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let timeText = '';
                    if (item.days > 0) {
                        timeText = `${item.days} hari ${item.hours} jam lagi`;
                    } else if (item.hours > 0) {
                        timeText = `${item.hours} jam ${item.minutes} menit lagi`;
                    } else {
                        timeText = `${item.minutes} menit lagi`;
                    }
                    
                    html += `
                        <div class="notification-item notification-item-soon">
                            <div class="notification-desc">
                                ${t.type === 'debt' ? 'üí≥' : 'üí∞'} ${t.debtPerson || 'Tidak disebutkan'} - ${t.description}
                            </div>
                            <div class="notification-detail">
                                <div>‚è∞ Jatuh tempo: ${dueDateStr} (${timeText})</div>
                                <div>üíµ Sisa: ${formatCurrency(item.remaining)}</div>
                            </div>
                            <div class="notification-actions">
                                <button class="btn-pay" onclick="toggleNotificationPanel(); showPaymentDialog(${item.index})">üí∞ Bayar</button>
                                <button class="btn-paid-full" onclick="toggleNotificationPanel(); showPaymentDialog(${item.index})">‚úÖ Lunas</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function getDueDateBadge(transaction) {
            if (!transaction.debtDueDate || transaction.isPaid) return '';
            
            const now = new Date();
            const dueDate = new Date(transaction.debtDueDate);
            
            const diffMs = dueDate - now;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMs < 0) {
                const absMinutes = Math.abs(diffMinutes);
                const absHours = Math.floor(absMinutes / 60);
                const absDays = Math.floor(absHours / 24);
                const remainingHours = absHours % 24;
                
                if (absDays > 0) {
                    return `<span class="debt-badge badge-overdue">‚ö†Ô∏è LEWAT ${absDays} HARI</span>`;
                } else if (absHours > 0) {
                    return `<span class="debt-badge badge-overdue">‚ö†Ô∏è LEWAT ${absHours} JAM</span>`;
                } else {
                    return `<span class="debt-badge badge-overdue">‚ö†Ô∏è LEWAT ${absMinutes} MENIT</span>`;
                }
            } else if (diffMinutes < 60) {
                return `<span class="debt-badge badge-due-soon">‚ö†Ô∏è ${diffMinutes} MENIT LAGI</span>`;
            } else if (diffHours < 24) {
                return `<span class="debt-badge badge-due-soon">‚ö†Ô∏è ${diffHours} JAM LAGI</span>`;
            } else if (diffDays <= 7) {
                return `<span class="debt-badge badge-due-soon">‚ö†Ô∏è ${diffDays} HARI LAGI</span>`;
            }
            
            return '';
        }

        function setMainMode(mode) {
            mainMode = mode;
            const transactionBtn = document.getElementById('mainModeBtn');
            const shopBtn = document.getElementById('shopModeBtn');
            const transactionContent = document.getElementById('transactionModeContent');
            const shopContent = document.getElementById('shopModeContent');
            
            if (mode === 'transaction') {
                transactionBtn.classList.add('active');
                shopBtn.classList.remove('active');
                transactionContent.style.display = 'block';
                shopContent.classList.remove('active');
            } else {
                transactionBtn.classList.remove('active');
                shopBtn.classList.add('active');
                transactionContent.style.display = 'none';
                shopContent.classList.add('active');
                displayProducts();
            }
        }

        function loadProducts() {
            try {
                const data = localStorage.getItem(PRODUCTS_KEY);
                let products = data ? JSON.parse(data) : [];
        
                // PERBAIKAN: Tambahkan ID untuk produk lama yang belum punya ID
                let needSave = false;
                products = products.map(p => {
                    if (!p.id || typeof p.id === 'number') { // Check juga kalau ID masih pakai timestamp number
                        needSave = true;
                        return {
                            ...p,
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                        };
                    }
                    return p;
                });
        
                // Auto-save jika ada produk yang ditambahkan ID
                if (needSave) {
                    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
                    console.log('‚úÖ Migration: Added IDs to', products.length, 'products');
                }
        
                return products;
            } catch (error) {
                console.error('Error loading products:', error);
                return [];
            }
        }

        function saveProducts() {
            try {
                localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
            } catch (error) {
                console.error('Error saving products:', error);
                alert('‚ö†Ô∏è Gagal menyimpan data produk!');
            }
        }

        function getProductSoldCount(productId) {
            let count = 0;
            transactions.forEach(t => {
                if ((t.type === 'income' || t.type === 'receivable') && t.isDetailed) {
                    const desc = t.description.toLowerCase();
                    const product = products.find(p => p.id === productId);
                    if (product && desc.includes(product.name.toLowerCase())) {
                        count += t.detailedQty;
                    }
                }
            });
            return count;
        }

        function getProductSoldValue(productId) {
            let total = 0;
            transactions.forEach(t => {
                if ((t.type === 'income' || t.type === 'receivable') && t.isDetailed) {
                    const desc = t.description.toLowerCase();
                    const product = products.find(p => p.id === productId);
                    if (product && desc.includes(product.name.toLowerCase())) {
                        total += t.amount;
                    }
                }
            });
            return total;
        }

        function showAddProductDialog() {
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productDescription').value = '';
            clearProductPhotoPreview();
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('addProductDialog').style.display = 'block';
        }

        function closeAddProductDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('addProductDialog').style.display = 'none';
            clearProductPhotoPreview();
        }

        function confirmAddProduct() {
            const name = document.getElementById('productName').value.trim();
            const priceInput = document.getElementById('productPrice').value;
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value.trim();
            
            if (!name || !priceInput || isNaN(stock)) {
                alert('Mohon isi semua field yang wajib!');
                return;
            }
            
            const price = parseAmount(priceInput);
            
            if (price <= 0) {
                alert('Harga harus lebih dari 0!');
                return;
            }
            
            if (stock < 0) {
                alert('Stok tidak boleh negatif!');
                return;
            }
            
            const product = {
               id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: name,
                price: price,
                stock: stock,
                description: description,
                photo: currentProductPhotoData
            };
            
            products.push(product);
            saveProducts();
            displayProducts();
            closeAddProductDialog();
            
            alert('‚úÖ Produk berhasil ditambahkan!');
        }

        function toggleProductFilter() {
            const menu = document.getElementById('productFilterMenu');
            menu.classList.toggle('active');
        }

        function selectProductFilter(filter) {
            productFilterMode = filter;
            
            const options = document.querySelectorAll('.product-filter-option');
            options.forEach(opt => {
                if (opt.getAttribute('data-filter') === filter) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            const labels = {
                'newest': 'Urutkan: Terbaru',
                'name-asc': 'Urutkan: Nama (A-Z)',
                'name-desc': 'Urutkan: Nama (Z-A)',
                'price-asc': 'Urutkan: Harga Termurah',
                'price-desc': 'Urutkan: Harga Termahal',
                'stock-asc': 'Urutkan: Stok Terkecil',
                'stock-desc': 'Urutkan: Stok Terbanyak',
                'sold-count': 'Urutkan: Terlaris (Jumlah)',
                'sold-value': 'Urutkan: Terlaris (Nilai)'
            };
            
            document.getElementById('productFilterLabel').textContent = labels[filter];
            document.getElementById('productFilterMenu').classList.remove('active');
            
            displayProducts();
        }

        function toggleProductsExpanded() {
            productsExpanded = !productsExpanded;
            const btn = document.getElementById('btnToggleProducts');
            const grid = document.querySelector('.products-grid');
    
            if (productsExpanded) {
                btn.textContent = '‚ñ≤ Ciutkan';
                if (grid) grid.classList.add('expanded');
            } else {
                btn.textContent = '‚ñº Lihat Semua';
                if (grid) grid.classList.remove('expanded');
            }
        }

        function displayProducts() {
            const list = document.getElementById('productsList');
            
            let filtered = products;
            
            if (productSearchTerm) {
                filtered = products.filter(p => 
                    p.name.toLowerCase().includes(productSearchTerm) ||
                    (p.description && p.description.toLowerCase().includes(productSearchTerm))
                );
            }
            
            filtered = [...filtered];
            if (productFilterMode === 'newest') {
                filtered.reverse();
            } else if (productFilterMode === 'name-asc') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else if (productFilterMode === 'name-desc') {
                filtered.sort((a, b) => b.name.localeCompare(a.name));
            } else if (productFilterMode === 'price-asc') {
                filtered.sort((a, b) => a.price - b.price);
            } else if (productFilterMode === 'price-desc') {
                filtered.sort((a, b) => b.price - a.price);
            } else if (productFilterMode === 'stock-asc') {
                filtered.sort((a, b) => a.stock - b.stock);
            } else if (productFilterMode === 'stock-desc') {
                filtered.sort((a, b) => b.stock - a.stock);
            } else if (productFilterMode === 'sold-count') {
                filtered.sort((a, b) => getProductSoldCount(b.id) - getProductSoldCount(a.id));
            } else if (productFilterMode === 'sold-value') {
                filtered.sort((a, b) => getProductSoldValue(b.id) - getProductSoldValue(a.id));
            }
            
            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-data">Tidak ada produk yang ditemukan</p>';
                return;
            }
            
            list.innerHTML = filtered.map((p, index) => {
                const originalIndex = products.indexOf(p);
                const imageHTML = p.photo ? 
                    `<img src="${p.photo}" alt="${p.name}">` : 
                    `<span class="product-image-placeholder">üì¶</span>`;
                
                const soldCount = getProductSoldCount(p.id);
                
                return `
                    <div class="product-card" id="product-${originalIndex}">
                        <div class="product-image-container">
                            ${imageHTML}
                        </div>
                        <div class="product-name">${p.name}</div>
                        <div class="product-price">${formatCurrency(p.price)}</div>
                        <div class="product-stock">üì¶ Stok: ${p.stock}</div>
                        <div class="product-sold">‚úÖ Terjual: ${soldCount}</div>
                        <div class="product-actions">
                            <button class="btn-buy-product" onclick="buyProductDirect(${originalIndex})">üõí Beli</button>
                            <button class="btn-product-menu" onclick="toggleProductMenu(${originalIndex})">‚öôÔ∏è Menu</button>
                        </div>
                        <div class="product-menu-popup" id="productMenu-${originalIndex}">
                            <div class="product-menu-item" onclick="showEditProductDialog(${originalIndex})">‚úèÔ∏è Edit</div>
                            <div class="product-menu-item" onclick="deleteProduct(${originalIndex})">üóëÔ∏è Hapus</div>
                            <div class="product-menu-item" onclick="showAddStockDialog(${originalIndex})">üì¶ Tambah Stok</div>
                        </div>
                    </div>
                `;
            }).join('');
			
                // Update state expanded
                const grid = document.querySelector('.products-grid');
                if (grid) {
                    if (productsExpanded) {
                        grid.classList.add('expanded');
                    } else {
                        grid.classList.remove('expanded');
                    }
                }
        }

        function toggleProductMenu(index) {
            const menu = document.getElementById(`productMenu-${index}`);
            document.querySelectorAll('.product-menu-popup').forEach(m => {
                if (m.id !== `productMenu-${index}`) {
                    m.classList.remove('active');
                }
            });
            menu.classList.toggle('active');
        }

        function buyProductDirect(index) {
            const product = products[index];
            
            if (product.stock <= 0) {
                alert('Stok produk habis!');
                return;
            }
            
            const existing = directSaleItems.find(item => item.productIndex === index);
            if (existing) {
                if (existing.quantity < existing.maxStock) {
                    existing.quantity++;
                    displayDirectSaleItems();
                    alert(`‚úÖ ${product.name} ditambahkan!\nJumlah sekarang: ${existing.quantity}`);
                } else {
                    alert(`‚ö†Ô∏è Stok ${product.name} tidak mencukupi!`);
                }
            } else {
                directSaleItems.push({
                    productIndex: index,
                    productName: product.name,
                    price: product.price,
                    quantity: 1,
                    maxStock: product.stock
                });
                displayDirectSaleItems();
                alert(`‚úÖ ${product.name} ditambahkan ke daftar!`);
            }
        }

        function displayDirectSaleItems() {
            const list = document.getElementById('directSaleItemsList');
    
            if (directSaleItems.length === 0) {
                list.innerHTML = '<p class="no-data">Belum ada barang dipilih</p>';
                document.getElementById('directSaleSubtotal').textContent = 'Rp 0';
                document.getElementById('directSaleTotal').textContent = 'Rp 0';
                return;
            }
    
            let subtotal = 0;
    
            list.innerHTML = directSaleItems.map((item, idx) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
        
                return `
                    <div class="sale-item">
                        <div class="sale-item-header">
                            <div class="sale-item-name">${item.productName}</div>
                            <button class="btn-delete" onclick="removeDirectSaleItem(${idx})" style="margin-left: auto;">üóëÔ∏è</button>
                        </div>
                        <div class="sale-item-details">
                            ${formatCurrency(item.price)} √ó ${item.quantity} = ${formatCurrency(itemTotal)}
                        </div>
                        <div class="sale-item-actions">
                            <button class="btn-qty btn-qty-minus" onclick="decreaseDirectSaleItemQty(${idx})">‚ûñ</button>
                            <input type="number" value="${item.quantity}" min="1" max="${item.maxStock}" 
                                   style="width: 60px; text-align: center; font-weight: bold; margin: 0 10px; padding: 5px; border: 2px solid #667eea; border-radius: 6px;" 
                                   oninput="updateDirectSaleItemQtyRealtime(${idx}, this.value)"
                                   onblur="validateDirectSaleItemQty(${idx}, this.value)">
                            <button class="btn-qty btn-qty-plus" onclick="increaseDirectSaleItemQty(${idx})">‚ûï</button>
                        </div>
                    </div>
                `;
            }).join('');
    
            document.getElementById('directSaleSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('directSaleTotal').textContent = formatCurrency(subtotal);
            // Update interest preview jika aktif
            if (document.getElementById('directSaleHasInterest') && document.getElementById('directSaleHasInterest').checked) {
                calculateDirectSaleInterestPreview();
            }
        }
		
        function updateDirectSaleItemQtyRealtime(idx, newQty) {
            const item = directSaleItems[idx];
            const qty = parseInt(newQty) || 0;
    
            if (qty >= 0) {
                item.quantity = qty;
            }
    
            let subtotal = 0;
            directSaleItems.forEach(item => {
                subtotal += item.price * item.quantity;
            });
    
            document.getElementById('directSaleSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('directSaleTotal').textContent = formatCurrency(subtotal);
            // Update interest preview jika aktif
            if (document.getElementById('directSaleHasInterest') && document.getElementById('directSaleHasInterest').checked) {
                calculateDirectSaleInterestPreview();
            }
        }

        function validateDirectSaleItemQty(idx, newQty) {
            const item = directSaleItems[idx];
            const qty = parseInt(newQty) || 1;
    
            if (qty < 1) {
                alert('Jumlah minimal adalah 1!');
                item.quantity = 1;
                displayDirectSaleItems();
                return;
            }
    
            if (qty > item.maxStock) {
                alert(`‚ö†Ô∏è Stok ${item.productName} tidak mencukupi! (Maks: ${item.maxStock})`);
                item.quantity = item.maxStock;
                displayDirectSaleItems();
                return;
            }
    
            item.quantity = qty;
            displayDirectSaleItems();
        }
		
        function removeDirectSaleItem(idx) {
            if (confirm(`Hapus ${directSaleItems[idx].productName} dari daftar?`)) {
                directSaleItems.splice(idx, 1);
                displayDirectSaleItems();
            }
        }
		
		function increaseDirectSaleItemQty(idx) {
            const item = directSaleItems[idx];
            if (item.quantity < item.maxStock) {
                item.quantity++;
                displayDirectSaleItems();
            } else {
                alert(`‚ö†Ô∏è Stok ${item.productName} tidak mencukupi! (Maks: ${item.maxStock})`);
            }
        }

        function decreaseDirectSaleItemQty(idx) {
            const item = directSaleItems[idx];
            if (item.quantity > 1) {
                item.quantity--;
                displayDirectSaleItems();
            } else {
                if (confirm(`Hapus ${item.productName} dari daftar?`)) {
                    directSaleItems.splice(idx, 1);
                    displayDirectSaleItems();
                }
            }
        }

        function toggleDirectSaleDebtFields() {
            const method = document.getElementById('directSalePaymentMethod').value;
            const fields = document.getElementById('directSaleDebtFields');
            
            if (method === 'credit') {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
            }
        }

        function toggleDirectSaleInterestFields() {
            const hasInterest = document.getElementById('directSaleHasInterest').checked;
            const fields = document.getElementById('directSaleInterestFields');
    
            if (hasInterest) {
                fields.classList.remove('hidden');
                calculateDirectSaleInterestPreview();
            } else {
                fields.classList.add('hidden');
            }
        }

        function calculateDirectSaleInterestPreview() {
            const totalText = document.getElementById('directSaleTotal').textContent.replace('Rp ', '');
            const amount = parseAmount(totalText);
            const rateInput = document.getElementById('directSaleInterestRate').value;
            const rate = parseInterestRate(rateInput);
            const period = document.getElementById('directSaleInterestPeriod').value;
    
            if (amount <= 0 || rate <= 0) {
                document.getElementById('directSaleInterestPreview').textContent = 'Isi nominal dan bunga untuk melihat preview';
                return;
            }
    
            const interest = (amount * rate) / 100;
            const total = amount + interest;
    
            let periodText = '';
            if (period === 'day') periodText = 'per hari';
            else if (period === 'week') periodText = 'per minggu';
            else if (period === 'month') periodText = 'per bulan';
            else if (period === 'year') periodText = 'per tahun';
    
            document.getElementById('directSaleInterestPreview').innerHTML = `
                Pokok: ${formatCurrency(amount)}<br>
                Bunga ${rate}% ${periodText}: ${formatCurrency(interest)}<br>
                <strong>Total ${periodText}: ${formatCurrency(total)}</strong>
            `;
        }

        function processDirectSale() {
            if (directSaleItems.length === 0) {
                alert('Belum ada barang yang dipilih!');
                return;
            }

            // Validasi stock sebelum proses
            for (let item of directSaleItems) {
                const product = products[item.productIndex];
                if (product.stock < item.quantity) {
                    alert(`‚ö†Ô∏è Stok ${product.name} tidak mencukupi!\nStok tersedia: ${product.stock}\nYang dipilih: ${item.quantity}`);
                    return;
                }
            }

            const method = document.getElementById('directSalePaymentMethod').value;
            const notes = document.getElementById('directSaleNotes').value.trim();
            const buyerName = document.getElementById('directSaleBuyerName').value.trim();
            const dueDate = document.getElementById('directSaleDueDate').value;
            const hasInterest = document.getElementById('directSaleHasInterest').checked;
            let interestRate = 0;
            let interestPeriod = 'month';

            if (method === 'credit' && hasInterest) {
                const rateInput = document.getElementById('directSaleInterestRate').value;
                interestRate = parseInterestRate(rateInput);
                interestPeriod = document.getElementById('directSaleInterestPeriod').value;
    
                if (interestRate <= 0) {
                    alert('Mohon isi persentase bunga!');
                    return;
                }
            }

            if (method === 'credit' && !buyerName) {
                alert('Mohon isi nama pembeli untuk piutang!');
                return;
            }

            // Backup data untuk recovery jika error
            const backupTransactions = JSON.parse(JSON.stringify(transactions));
            const backupProducts = JSON.parse(JSON.stringify(products));
            const backupItems = JSON.parse(JSON.stringify(directSaleItems));

            try {
                // Proses setiap item
                directSaleItems.forEach(item => {
                    const product = products[item.productIndex];
            
                    const transaction = {
                        id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        type: method === 'cash' ? 'income' : 'receivable',
                        amount: item.price * item.quantity,
                        description: `${item.productName}`,
                        notes: notes || '',
                        isDetailed: true,
                        detailedPrice: item.price,
                        detailedQty: item.quantity,
                        datetime: new Date().toISOString(),
                        photo: null,
                        timestamp: new Date().getTime(),
                        isPaid: method === 'cash',
                        payments: [],
                        debtPerson: method === 'credit' ? buyerName : '',
                        debtDueDate: (method === 'credit' && dueDate) ? parseDateTimeManual(dueDate) : '',
                        debtType: 'goods',
                        hasInterest: method === 'credit' ? hasInterest : false,
                        interestRate: method === 'credit' ? interestRate : 0,
                        interestPeriod: method === 'credit' ? interestPeriod : 'month'
                    };

                    transactions.push(transaction);
                    product.stock -= item.quantity;
                });

                saveToStorage(transactions);
                saveProducts();

                const totalAmount = directSaleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const itemCount = directSaleItems.length;

                // Clear form
                directSaleItems = [];
                document.getElementById('directSalePaymentMethod').value = 'cash';
                document.getElementById('directSaleNotes').value = '';
                document.getElementById('directSaleBuyerName').value = '';
                document.getElementById('directSaleDueDate').value = '';
                toggleDirectSaleDebtFields();
                displayDirectSaleItems();
				document.getElementById('directSaleHasInterest').checked = false;
				document.getElementById('directSaleInterestRate').value = '';
				document.getElementById('directSaleInterestPeriod').value = 'month';
				toggleDirectSaleInterestFields();

                // Force refresh semua tampilan
                forceRefreshAllDisplays();

                alert(`‚úÖ Penjualan berhasil diproses!\n\nTotal Item: ${itemCount}\nTotal: ${formatCurrency(totalAmount)}\nMetode: ${method === 'cash' ? 'Tunai' : 'Piutang (Orang Berhutang Ke Saya)'}`);

            } catch (error) {
                // Restore backup jika error
                console.error('Error processing sale:', error);
                transactions = backupTransactions;
                products = backupProducts;
                directSaleItems = backupItems;
                saveToStorage(transactions);
                saveProducts();
                displayDirectSaleItems();
                alert('‚ùå Terjadi error saat memproses penjualan! Data telah dipulihkan.');
            }
        }

        function showEditProductDialog(index) {
            currentEditProductIndex = index;
            const p = products[index];
            
            document.getElementById('editProductName').value = p.name;
            document.getElementById('editProductPrice').value = p.price.toLocaleString('id-ID');
            document.getElementById('editProductStock').value = p.stock;
            document.getElementById('editProductDescription').value = p.description || '';
            
            if (p.photo) {
                currentEditProductPhotoData = p.photo;
                document.getElementById('editProductPhotoPreview').src = p.photo;
                document.getElementById('editProductPhotoPreview').style.display = 'block';
                document.getElementById('editProductPhotoUploadText').style.display = 'none';
                document.getElementById('editProductPhotoInfo').textContent = '‚úì Foto produk tersimpan';
            } else {
                currentEditProductPhotoData = null;
                document.getElementById('editProductPhotoPreview').style.display = 'none';
                document.getElementById('editProductPhotoUploadText').style.display = 'block';
                document.getElementById('editProductPhotoInfo').textContent = '';
            }
            
            document.querySelectorAll('.product-menu-popup').forEach(m => m.classList.remove('active'));
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('editProductDialog').style.display = 'block';
        }

        function closeEditProductDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('editProductDialog').style.display = 'none';
            currentEditProductIndex = null;
            currentEditProductPhotoData = null;
            document.getElementById('editProductPhotoInput').value = '';
        }

        function confirmEditProduct() {
            if (currentEditProductIndex === null) return;
            
            const name = document.getElementById('editProductName').value.trim();
            const priceInput = document.getElementById('editProductPrice').value;
            const stock = parseInt(document.getElementById('editProductStock').value);
            const description = document.getElementById('editProductDescription').value.trim();
            
            if (!name || !priceInput || isNaN(stock)) {
                alert('Mohon isi semua field yang wajib!');
                return;
            }
            
            const price = parseAmount(priceInput);
            
            if (price <= 0) {
                alert('Harga harus lebih dari 0!');
                return;
            }
            
            if (stock < 0) {
                alert('Stok tidak boleh negatif!');
                return;
            }
            
            products[currentEditProductIndex].name = name;
            products[currentEditProductIndex].price = price;
            products[currentEditProductIndex].stock = stock;
            products[currentEditProductIndex].description = description;
            
            if (currentEditProductPhotoData) {
                products[currentEditProductIndex].photo = currentEditProductPhotoData;
            }
            
            saveProducts();
            displayProducts();
            closeEditProductDialog();
            
            alert('‚úÖ Produk berhasil diupdate!');
        }

        function deleteProduct(index) {
            document.querySelectorAll('.product-menu-popup').forEach(m => m.classList.remove('active'));
            
            if (confirm(`Hapus produk "${products[index].name}"?`)) {
                products.splice(index, 1);
                saveProducts();
                displayProducts();
            }
        }

        function showAddStockDialog(index) {
            document.querySelectorAll('.product-menu-popup').forEach(m => m.classList.remove('active'));
            
            currentAddStockProductIndex = index;
            const product = products[index];
            
            document.getElementById('addStockProductName').textContent = `Produk: ${product.name}`;
            document.getElementById('currentStockDisplay').value = product.stock;
            document.getElementById('addStockAmount').value = 1;
            updateNewStockDisplay();
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('addStockDialog').style.display = 'block';

            // PERBAIKAN: Remove listener lama sebelum add yang baru
            const stockInput = document.getElementById('addStockAmount');
            stockInput.removeEventListener('input', updateNewStockDisplay);
            stockInput.addEventListener('input', updateNewStockDisplay);
        }

        function closeAddStockDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('addStockDialog').style.display = 'none';
            currentAddStockProductIndex = null;
            document.getElementById('addStockAmount').removeEventListener('input', updateNewStockDisplay);
        }

        function updateNewStockDisplay() {
            if (currentAddStockProductIndex === null) return;
            
            const product = products[currentAddStockProductIndex];
            const addAmount = parseInt(document.getElementById('addStockAmount').value) || 0;
            const newStock = product.stock + addAmount;
            
            document.getElementById('newStockDisplay').textContent = newStock;
        }

        function confirmAddStock() {
            if (currentAddStockProductIndex === null) return;
            
            const addAmount = parseInt(document.getElementById('addStockAmount').value);
            
            if (isNaN(addAmount) || addAmount < 1) {
                alert('Jumlah yang ditambahkan harus minimal 1!');
                return;
            }
            
            const product = products[currentAddStockProductIndex];
            product.stock += addAmount;
            
            saveProducts();
            displayProducts();
            closeAddStockDialog();
            
            alert(`‚úÖ Stok berhasil ditambahkan!\n\n${product.name}\nTambahan: ${addAmount}\nStok sekarang: ${product.stock}`);
        }

        function handleProductSearch() {
            const input = document.getElementById('productSearchInput');
            productSearchTerm = input.value.trim().toLowerCase();
    
            const clearBtn = document.getElementById('productClearSearch');
            if (productSearchTerm) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
    
            displayProducts();
    
            // TAMBAHKAN INI
            const btn = document.getElementById('btnToggleProducts');
            if (btn) {
                btn.textContent = productsExpanded ? '‚ñ≤ Ciutkan' : '‚ñº Lihat Semua';
            }
        }

        function clearProductSearch() {
            document.getElementById('productSearchInput').value = '';
            productSearchTerm = '';
            document.getElementById('productClearSearch').classList.remove('visible');
            displayProducts();
        }

        function changePeriod(period) {
            currentPeriod = period;
            
            const tabs = document.querySelectorAll('#summaryPeriodTabs .tab');
            tabs.forEach((tab, index) => {
                if ((period === 'day' && index === 0) ||
                    (period === 'week' && index === 1) ||
                    (period === 'month' && index === 2) ||
                    (period === 'year' && index === 3) ||
                    (period === 'previous' && index === 4)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            const yearNav = document.getElementById('yearNavigation');
            const monthSelector = document.getElementById('monthSelector');
            
            if (period === 'previous') {
                yearNav.classList.remove('hidden');
                monthSelector.classList.remove('hidden');
                document.getElementById('yearInput').value = selectedYear;
                updateNextYearButton();
            } else {
                yearNav.classList.add('hidden');
                monthSelector.classList.add('hidden');
                selectedMonth = 'all';
            }
            
            updateSummary();
        }

        function navigateYear(direction) {
            selectedYear += direction;
            document.getElementById('yearInput').value = selectedYear;
            updateNextYearButton();
            updateSummary();
        }

        function changeYearManual() {
            const input = document.getElementById('yearInput');
            selectedYear = parseInt(input.value) || new Date().getFullYear();
            updateNextYearButton();
            updateSummary();
        }

        function updateNextYearButton() {
            const currentYear = new Date().getFullYear();
            const nextBtn = document.getElementById('nextYearBtn');
            
            if (selectedYear >= currentYear) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }

        function changeMonth(month) {
            selectedMonth = month;
            updateSummary();
        }

        function changeHistoryPeriod(period) {
            currentHistoryPeriod = period;
            
            const tabs = document.querySelectorAll('#historyPeriodTabs .tab');
            tabs.forEach((tab, index) => {
                if ((period === 'all' && index === 0) ||
                    (period === 'day' && index === 1) ||
                    (period === 'week' && index === 2) ||
                    (period === 'month' && index === 3) ||
                    (period === 'year' && index === 4) ||
                    (period === 'previous' && index === 5)) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            const yearNav = document.getElementById('historyYearNavigation');
            const monthSelector = document.getElementById('historyMonthSelector');
            
            if (period === 'previous') {
                yearNav.classList.remove('hidden');
                monthSelector.classList.remove('hidden');
                document.getElementById('historyYearInput').value = selectedHistoryYear;
                updateHistoryNextYearButton();
            } else {
                yearNav.classList.add('hidden');
                monthSelector.classList.add('hidden');
                selectedHistoryMonth = 'all';
            }
            
            displayTransactions();
        }

        function navigateHistoryYear(direction) {
            selectedHistoryYear += direction;
            document.getElementById('historyYearInput').value = selectedHistoryYear;
            updateHistoryNextYearButton();
            displayTransactions();
        }

        function changeHistoryYearManual() {
            const input = document.getElementById('historyYearInput');
            selectedHistoryYear = parseInt(input.value) || new Date().getFullYear();
            updateHistoryNextYearButton();
            displayTransactions();
        }

        function updateHistoryNextYearButton() {
            const currentYear = new Date().getFullYear();
            const nextBtn = document.getElementById('historyNextYearBtn');
            
            if (selectedHistoryYear >= currentYear) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }

        function changeHistoryMonth(month) {
            selectedHistoryMonth = month;
            displayTransactions();
        }
		
		function getFilteredTransactions(period, year, month) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return transactions.filter(t => {
                const transactionDate = new Date(t.datetime);
                
                if (period === 'day') {
                    return transactionDate >= today;
                } else if (period === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return transactionDate >= weekAgo;
                } else if (period === 'month') {
                    return transactionDate.getMonth() === now.getMonth() && 
                           transactionDate.getFullYear() === now.getFullYear();
                } else if (period === 'year') {
                    return transactionDate.getFullYear() === now.getFullYear();
                } else if (period === 'previous') {
                    if (month === 'all') {
                        return transactionDate.getFullYear() === year;
                    } else {
                        return transactionDate.getFullYear() === year && 
                               transactionDate.getMonth() === parseInt(month);
                    }
                }
                
                return true;
            });
        }

        function updateSummary() {
            const filtered = getFilteredTransactions(currentPeriod, selectedYear, selectedMonth);
            
            let totalIncome = 0;
            let totalExpense = 0;
            let totalDebt = 0;
            let totalReceivable = 0;
            
            filtered.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                } else if (t.type === 'debt') {
                    const remaining = getRemainingDebt(t);
                    if (remaining > 0) {
                        totalDebt += remaining;
                    }
                } else if (t.type === 'receivable') {
                    const remaining = getRemainingDebt(t);
                    if (remaining > 0) {
                        totalReceivable += remaining;
                    }
                }
            });
            
            const balance = totalIncome - totalExpense;
            const netBalance = balance - totalDebt + totalReceivable;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('totalBalance').textContent = formatCurrency(balance);
            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            document.getElementById('totalReceivable').textContent = formatCurrency(totalReceivable);
            document.getElementById('netBalance').textContent = formatCurrency(netBalance);
            
            displayIncomeDetails(filtered);
            displayExpenseDetails(filtered);
            displayDebtDetails(filtered);
            displayReceivableDetails(filtered);
        }

        function displayIncomeDetails(filtered) {
            const incomes = filtered.filter(t => t.type === 'income');
            const container = document.getElementById('incomeDetails');
            
            let html = `
                <h4>
                    <span>üìà Detail Pemasukan (${incomes.length})</span>
                    <div>
                        <button class="btn-view-all" onclick="toggleIncomeExpanded()">${incomeExpanded ? '‚ñ≤ Ciutkan' : '‚ñº Lihat Semua'}</button>
                        <div class="filter-detail-dropdown" style="display: inline-block;">
                            <button class="btn-filter-detail" onclick="toggleIncomeFilter()">üîΩ Filter</button>
                            <div class="filter-detail-menu" id="incomeFilterMenu">
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Urutkan:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="incomeSort" value="date-desc" ${incomeFilter.sort === 'date-desc' ? 'checked' : ''} id="incomeSort1">
                                            <label for="incomeSort1">Terbaru</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="incomeSort" value="date-asc" ${incomeFilter.sort === 'date-asc' ? 'checked' : ''} id="incomeSort2">
                                            <label for="incomeSort2">Terlama</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="incomeSort" value="amount-desc" ${incomeFilter.sort === 'amount-desc' ? 'checked' : ''} id="incomeSort3">
                                            <label for="incomeSort3">Tertinggi</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="incomeSort" value="amount-asc" ${incomeFilter.sort === 'amount-asc' ? 'checked' : ''} id="incomeSort4">
                                            <label for="incomeSort4">Terendah</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Rentang Nominal:</label>
                                    <input type="text" placeholder="Min" id="incomeMinAmount" value="${incomeFilter.minAmount}" oninput="formatAmountInput(this)" style="margin-bottom: 5px;">
                                    <input type="text" placeholder="Max" id="incomeMaxAmount" value="${incomeFilter.maxAmount}" oninput="formatAmountInput(this)">
                                </div>
                                <div class="filter-detail-buttons">
                                    <button class="btn-apply-filter" onclick="applyIncomeFilter()">Terapkan</button>
                                    <button class="btn-reset-filter" onclick="resetIncomeFilter()">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </h4>
            `;
            
            let filteredIncomes = incomes;
            
            if (incomeFilter.minAmount) {
                const min = parseAmount(incomeFilter.minAmount);
                filteredIncomes = filteredIncomes.filter(t => t.amount >= min);
            }
            
            if (incomeFilter.maxAmount) {
                const max = parseAmount(incomeFilter.maxAmount);
                filteredIncomes = filteredIncomes.filter(t => t.amount <= max);
            }
            
            filteredIncomes.sort((a, b) => {
                if (incomeFilter.sort === 'date-desc') return new Date(b.datetime) - new Date(a.datetime);
                if (incomeFilter.sort === 'date-asc') return new Date(a.datetime) - new Date(b.datetime);
                if (incomeFilter.sort === 'amount-desc') return b.amount - a.amount;
                if (incomeFilter.sort === 'amount-asc') return a.amount - b.amount;
                return 0;
            });
            
            const displayIncomes = incomeExpanded ? filteredIncomes : filteredIncomes.slice(0, 3);
            
            html += `<div class="detail-container ${incomeExpanded ? 'expanded' : ''}">`;
            
            if (displayIncomes.length === 0) {
                html += '<p class="no-data">Tidak ada pemasukan</p>';
            } else {
                displayIncomes.forEach(t => {
                    const date = new Date(t.datetime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="detail-item">
                            <div class="detail-item-header">
                                <div class="detail-desc">${t.description}</div>
                                <div class="detail-amount income">${formatCurrency(t.amount)}</div>
                            </div>
                            <div class="detail-specs">
                                <div>üìÖ ${dateStr}</div>
                                ${t.isDetailed ? `<div>üõí ${formatCurrency(t.detailedPrice)} √ó ${t.detailedQty}</div>` : ''}
                                ${t.notes ? `<div>üìù ${t.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayExpenseDetails(filtered) {
            const expenses = filtered.filter(t => t.type === 'expense');
            const container = document.getElementById('expenseDetails');
            
            let html = `
                <h4>
                    <span>üìâ Detail Pengeluaran (${expenses.length})</span>
                    <div>
                        <button class="btn-view-all" onclick="toggleExpenseExpanded()">${expenseExpanded ? '‚ñ≤ Ciutkan' : '‚ñº Lihat Semua'}</button>
                        <div class="filter-detail-dropdown" style="display: inline-block;">
                            <button class="btn-filter-detail" onclick="toggleExpenseFilter()">üîΩ Filter</button>
                            <div class="filter-detail-menu" id="expenseFilterMenu">
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Urutkan:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="expenseSort" value="date-desc" ${expenseFilter.sort === 'date-desc' ? 'checked' : ''} id="expenseSort1">
                                            <label for="expenseSort1">Terbaru</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="expenseSort" value="date-asc" ${expenseFilter.sort === 'date-asc' ? 'checked' : ''} id="expenseSort2">
                                            <label for="expenseSort2">Terlama</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="expenseSort" value="amount-desc" ${expenseFilter.sort === 'amount-desc' ? 'checked' : ''} id="expenseSort3">
                                            <label for="expenseSort3">Tertinggi</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="expenseSort" value="amount-asc" ${expenseFilter.sort === 'amount-asc' ? 'checked' : ''} id="expenseSort4">
                                            <label for="expenseSort4">Terendah</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Rentang Nominal:</label>
                                    <input type="text" placeholder="Min" id="expenseMinAmount" value="${expenseFilter.minAmount}" oninput="formatAmountInput(this)" style="margin-bottom: 5px;">
                                    <input type="text" placeholder="Max" id="expenseMaxAmount" value="${expenseFilter.maxAmount}" oninput="formatAmountInput(this)">
                                </div>
                                <div class="filter-detail-buttons">
                                    <button class="btn-apply-filter" onclick="applyExpenseFilter()">Terapkan</button>
                                    <button class="btn-reset-filter" onclick="resetExpenseFilter()">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </h4>
            `;
            
            let filteredExpenses = expenses;
            
            if (expenseFilter.minAmount) {
                const min = parseAmount(expenseFilter.minAmount);
                filteredExpenses = filteredExpenses.filter(t => t.amount >= min);
            }
            
            if (expenseFilter.maxAmount) {
                const max = parseAmount(expenseFilter.maxAmount);
                filteredExpenses = filteredExpenses.filter(t => t.amount <= max);
            }
            
            filteredExpenses.sort((a, b) => {
                if (expenseFilter.sort === 'date-desc') return new Date(b.datetime) - new Date(a.datetime);
                if (expenseFilter.sort === 'date-asc') return new Date(a.datetime) - new Date(b.datetime);
                if (expenseFilter.sort === 'amount-desc') return b.amount - a.amount;
                if (expenseFilter.sort === 'amount-asc') return a.amount - b.amount;
                return 0;
            });
            
            const displayExpenses = expenseExpanded ? filteredExpenses : filteredExpenses.slice(0, 3);
            
            html += `<div class="detail-container ${expenseExpanded ? 'expanded' : ''}">`;
            
            if (displayExpenses.length === 0) {
                html += '<p class="no-data">Tidak ada pengeluaran</p>';
            } else {
                displayExpenses.forEach(t => {
                    const date = new Date(t.datetime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="detail-item">
                            <div class="detail-item-header">
                                <div class="detail-desc">${t.description}</div>
                                <div class="detail-amount expense">${formatCurrency(t.amount)}</div>
                            </div>
                            <div class="detail-specs">
                                <div>üìÖ ${dateStr}</div>
                                ${t.isDetailed ? `<div>üõí ${formatCurrency(t.detailedPrice)} √ó ${t.detailedQty}</div>` : ''}
                                ${t.notes ? `<div>üìù ${t.notes}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayDebtDetails(filtered) {
            // FORCE FRESH DATA dari filtered transactions
            const debts = filtered.filter(t => t.type === 'debt');
            const container = document.getElementById('debtDetailsSection');

            let html = `
                <h4>
                    <span>üí≥ Detail Hutang (${debts.length})</span>
                    <div>
                        <button class="btn-view-all" onclick="toggleDebtExpanded()">${debtExpanded ? '‚ñ≤ Ciutkan' : '‚ñº Lihat Semua'}</button>
                        <div class="filter-detail-dropdown" style="display: inline-block;">
                            <button class="btn-filter-detail" onclick="toggleDebtFilter()">üîΩ Filter</button>
                            <div class="filter-detail-menu" id="debtFilterMenu">
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Status:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtStatus" value="all" ${debtFilter.status === 'all' ? 'checked' : ''} id="debtStatus1">
                                            <label for="debtStatus1">Semua</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtStatus" value="unpaid" ${debtFilter.status === 'unpaid' ? 'checked' : ''} id="debtStatus2">
                                            <label for="debtStatus2">Belum Lunas</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtStatus" value="paid" ${debtFilter.status === 'paid' ? 'checked' : ''} id="debtStatus3">
                                            <label for="debtStatus3">Lunas</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Urutkan:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtSort" value="date-desc" ${debtFilter.sort === 'date-desc' ? 'checked' : ''} id="debtSort1">
                                            <label for="debtSort1">Terbaru</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtSort" value="date-asc" ${debtFilter.sort === 'date-asc' ? 'checked' : ''} id="debtSort2">
                                            <label for="debtSort2">Terlama</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtSort" value="amount-desc" ${debtFilter.sort === 'amount-desc' ? 'checked' : ''} id="debtSort3">
                                            <label for="debtSort3">Tertinggi</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="debtSort" value="amount-asc" ${debtFilter.sort === 'amount-asc' ? 'checked' : ''} id="debtSort4">
                                            <label for="debtSort4">Terendah</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-buttons">
                                    <button class="btn-apply-filter" onclick="applyDebtFilter()">Terapkan</button>
                                    <button class="btn-reset-filter" onclick="resetDebtFilter()">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </h4>
            `;

            let filteredDebts = debts;

            if (debtFilter.status === 'unpaid') {
                filteredDebts = filteredDebts.filter(t => !t.isPaid);
            } else if (debtFilter.status === 'paid') {
                filteredDebts = filteredDebts.filter(t => t.isPaid);
            }

            filteredDebts.sort((a, b) => {
                if (debtFilter.sort === 'date-desc') return new Date(b.datetime) - new Date(a.datetime);
                if (debtFilter.sort === 'date-asc') return new Date(a.datetime) - new Date(b.datetime);
                if (debtFilter.sort === 'amount-desc') return getRemainingDebt(b) - getRemainingDebt(a);
                if (debtFilter.sort === 'amount-asc') return getRemainingDebt(a) - getRemainingDebt(b);
                return 0;
            });

            const displayDebts = debtExpanded ? filteredDebts : filteredDebts.slice(0, 3);

            html += `<div class="detail-container ${debtExpanded ? 'expanded' : ''}">`;

            if (displayDebts.length === 0) {
                html += '<p class="no-data">Tidak ada hutang</p>';
            } else {
                displayDebts.forEach((t) => {
                    // PERBAIKAN: Ambil index berdasarkan ID unik dengan fallback
                    let originalIndex = transactions.findIndex(tx => tx.id === t.id);
            
                    // FALLBACK: Jika ID tidak ketemu (untuk data lama tanpa ID)
                    if (originalIndex === -1) {
                        originalIndex = transactions.findIndex(tx => 
                            tx.timestamp === t.timestamp && 
                            tx.datetime === t.datetime &&
                            tx.description === t.description
                        );
                    }
    
                    // FORCE RECALCULATE remaining debt
                    const remaining = getRemainingDebt(t);
                    const date = new Date(t.datetime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
    
                    const progress = ((t.amount - remaining) / t.amount) * 100;
                    const dueBadge = getDueDateBadge(t);
    
                    html += `
                        <div class="detail-item">
                            <div class="detail-item-header">
                                <div class="detail-desc">
                                    ${t.description}
                                    ${t.isPaid ? '<span class="debt-badge badge-paid">‚úì LUNAS</span>' : dueBadge}
                                </div>
                                <div class="detail-amount debt">${formatCurrency(remaining)}</div>
                            </div>
                            <div class="detail-specs">
                                <div>üë§ ${t.debtPerson || 'Tidak disebutkan'}</div>
                                <div>üìÇ ${t.debtType === 'money' ? 'Pinjaman Uang' : 'Barang/Jasa'}</div>
                                ${t.hasInterest ? `<div>üí∞ Bunga: ${t.interestRate}% per ${t.interestPeriod === 'day' ? 'hari' : t.interestPeriod === 'week' ? 'minggu' : t.interestPeriod === 'month' ? 'bulan' : 'tahun'}</div>` : ''}
                                <div>üìÖ ${dateStr}</div>
                                ${t.debtDueDate ? `<div>‚è∞ Jatuh tempo: ${new Date(t.debtDueDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>` : ''}
                                <div>üí∞ Total Hutang: ${formatCurrency(t.amount)}</div>
                                ${t.payments && t.payments.length > 0 ? `<div>üìä Terbayar: ${formatCurrency(t.amount - remaining)} (${progress.toFixed(1)}%)</div>` : ''}
                                ${t.notes ? `<div>üìù ${t.notes}</div>` : ''}
                            </div>
                            ${!t.isPaid && t.payments && t.payments.length > 0 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            ` : ''}
                            <div class="detail-actions">
                                ${!t.isPaid ? `<button class="btn-pay" onclick="showPaymentDialog(${originalIndex})">üí∞ Bayar</button>` : ''}
                                ${t.payments && t.payments.length > 0 ? `<button class="btn-history" onclick="showPaymentHistory(${originalIndex})">üìú Riwayat</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function displayReceivableDetails(filtered) {
            // FORCE FRESH DATA dari filtered transactions
            const receivables = filtered.filter(t => t.type === 'receivable');
            const container = document.getElementById('receivableDetailsSection');

            let html = `
                <h4>
                    <span>üí∞ Detail Piutang (${receivables.length})</span>
                    <div>
                        <button class="btn-view-all" onclick="toggleReceivableExpanded()">${receivableExpanded ? '‚ñ≤ Ciutkan' : '‚ñº Lihat Semua'}</button>
                        <div class="filter-detail-dropdown" style="display: inline-block;">
                            <button class="btn-filter-detail" onclick="toggleReceivableFilter()">üîΩ Filter</button>
                            <div class="filter-detail-menu" id="receivableFilterMenu">
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Status:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableStatus" value="all" ${receivableFilter.status === 'all' ? 'checked' : ''} id="receivableStatus1">
                                            <label for="receivableStatus1">Semua</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableStatus" value="unpaid" ${receivableFilter.status === 'unpaid' ? 'checked' : ''} id="receivableStatus2">
                                            <label for="receivableStatus2">Belum Lunas</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableStatus" value="paid" ${receivableFilter.status === 'paid' ? 'checked' : ''} id="receivableStatus3">
                                            <label for="receivableStatus3">Lunas</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-section">
                                    <label class="filter-detail-label">Urutkan:</label>
                                    <div class="filter-detail-options">
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableSort" value="date-desc" ${receivableFilter.sort === 'date-desc' ? 'checked' : ''} id="receivableSort1">
                                            <label for="receivableSort1">Terbaru</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableSort" value="date-asc" ${receivableFilter.sort === 'date-asc' ? 'checked' : ''} id="receivableSort2">
                                            <label for="receivableSort2">Terlama</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableSort" value="amount-desc" ${receivableFilter.sort === 'amount-desc' ? 'checked' : ''} id="receivableSort3">
                                            <label for="receivableSort3">Tertinggi</label>
                                        </div>
                                        <div class="filter-detail-option">
                                            <input type="radio" name="receivableSort" value="amount-asc" ${receivableFilter.sort === 'amount-asc' ? 'checked' : ''} id="receivableSort4">
                                            <label for="receivableSort4">Terendah</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-detail-buttons">
                                    <button class="btn-apply-filter" onclick="applyReceivableFilter()">Terapkan</button>
                                    <button class="btn-reset-filter" onclick="resetReceivableFilter()">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </h4>
            `;

            let filteredReceivables = receivables;

            if (receivableFilter.status === 'unpaid') {
                filteredReceivables = filteredReceivables.filter(t => !t.isPaid);
            } else if (receivableFilter.status === 'paid') {
                filteredReceivables = filteredReceivables.filter(t => t.isPaid);
            }

            filteredReceivables.sort((a, b) => {
                if (receivableFilter.sort === 'date-desc') return new Date(b.datetime) - new Date(a.datetime);
                if (receivableFilter.sort === 'date-asc') return new Date(a.datetime) - new Date(b.datetime);
                if (receivableFilter.sort === 'amount-desc') return getRemainingDebt(b) - getRemainingDebt(a);
                if (receivableFilter.sort === 'amount-asc') return getRemainingDebt(a) - getRemainingDebt(b);
                return 0;
            });

            const displayReceivables = receivableExpanded ? filteredReceivables : filteredReceivables.slice(0, 3);

            html += `<div class="detail-container ${receivableExpanded ? 'expanded' : ''}">`;

            if (displayReceivables.length === 0) {
                html += '<p class="no-data">Tidak ada piutang</p>';
            } else {
                displayReceivables.forEach((t) => {
                    // PERBAIKAN: Ambil index berdasarkan ID unik dengan fallback
                    let originalIndex = transactions.findIndex(tx => tx.id === t.id);
            
                    // FALLBACK: Jika ID tidak ketemu (untuk data lama tanpa ID)
                    if (originalIndex === -1) {
                        originalIndex = transactions.findIndex(tx => 
                            tx.timestamp === t.timestamp && 
                            tx.datetime === t.datetime &&
                            tx.description === t.description
                        );
                    }
    
                    // FORCE RECALCULATE remaining debt
                    const remaining = getRemainingDebt(t);
                    const date = new Date(t.datetime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
    
                    const progress = ((t.amount - remaining) / t.amount) * 100;
                    const dueBadge = getDueDateBadge(t);
    
                    html += `
                        <div class="detail-item">
                            <div class="detail-item-header">
                                <div class="detail-desc">
                                    ${t.description}
                                    ${t.isPaid ? '<span class="debt-badge badge-paid">‚úì LUNAS</span>' : dueBadge}
                                </div>
                                <div class="detail-amount receivable">${formatCurrency(remaining)}</div>
                            </div>
                            <div class="detail-specs">
                                <div>üë§ ${t.debtPerson || 'Tidak disebutkan'}</div>
                                <div>üìÇ ${t.debtType === 'money' ? 'Pinjaman Uang' : 'Barang/Jasa'}</div>
                                ${t.hasInterest ? `<div>üí∞ Bunga: ${t.interestRate}% per ${t.interestPeriod === 'day' ? 'hari' : t.interestPeriod === 'week' ? 'minggu' : t.interestPeriod === 'month' ? 'bulan' : 'tahun'}</div>` : ''}
                                <div>üìÖ ${dateStr}</div>
                                ${t.debtDueDate ? `<div>‚è∞ Jatuh tempo: ${new Date(t.debtDueDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>` : ''}
                                <div>üí∞ Total Piutang: ${formatCurrency(t.amount)}</div>
                                ${t.payments && t.payments.length > 0 ? `<div>üìä Terbayar: ${formatCurrency(t.amount - remaining)} (${progress.toFixed(1)}%)</div>` : ''}
                                ${t.notes ? `<div>üìù ${t.notes}</div>` : ''}
                            </div>
                            ${!t.isPaid && t.payments && t.payments.length > 0 ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                            ` : ''}
                            <div class="detail-actions">
                                ${!t.isPaid ? `<button class="btn-pay" onclick="showPaymentDialog(${originalIndex})">üí∞ Terima Bayar</button>` : ''}
                                ${t.payments && t.payments.length > 0 ? `<button class="btn-history" onclick="showPaymentHistory(${originalIndex})">üìú Riwayat</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function toggleIncomeExpanded() {
            incomeExpanded = !incomeExpanded;
            updateSummary();
        }

        function toggleExpenseExpanded() {
            expenseExpanded = !expenseExpanded;
            updateSummary();
        }

        function toggleDebtExpanded() {
            debtExpanded = !debtExpanded;
            updateSummary();
        }

        function toggleReceivableExpanded() {
            receivableExpanded = !receivableExpanded;
            updateSummary();
        }

        function toggleIncomeFilter() {
            const menu = document.getElementById('incomeFilterMenu');
            menu.classList.toggle('active');
        }

        function toggleExpenseFilter() {
            const menu = document.getElementById('expenseFilterMenu');
            menu.classList.toggle('active');
        }

        function toggleDebtFilter() {
            const menu = document.getElementById('debtFilterMenu');
            menu.classList.toggle('active');
        }

        function toggleReceivableFilter() {
            const menu = document.getElementById('receivableFilterMenu');
            menu.classList.toggle('active');
        }

        function applyIncomeFilter() {
            incomeFilter.sort = document.querySelector('input[name="incomeSort"]:checked').value;
            incomeFilter.minAmount = document.getElementById('incomeMinAmount').value;
            incomeFilter.maxAmount = document.getElementById('incomeMaxAmount').value;
    
            // PERBAIKAN: Validasi input amount
            if (incomeFilter.minAmount && incomeFilter.maxAmount) {
                const min = parseAmount(incomeFilter.minAmount);
                const max = parseAmount(incomeFilter.maxAmount);
                if (min > max) {
                    alert('‚ö†Ô∏è Nominal minimum tidak boleh lebih besar dari maksimum!');
                    return;
                }
            }
            document.getElementById('incomeFilterMenu').classList.remove('active');
            updateSummary();
        }

        function resetIncomeFilter() {
            incomeFilter = { sort: 'date-desc', minAmount: '', maxAmount: '' };
            document.getElementById('incomeFilterMenu').classList.remove('active');
            updateSummary();
        }

        function applyExpenseFilter() {
            expenseFilter.sort = document.querySelector('input[name="expenseSort"]:checked').value;
            expenseFilter.minAmount = document.getElementById('expenseMinAmount').value;
            expenseFilter.maxAmount = document.getElementById('expenseMaxAmount').value;
            document.getElementById('expenseFilterMenu').classList.remove('active');
            updateSummary();
        }

        function resetExpenseFilter() {
            expenseFilter = { sort: 'date-desc', minAmount: '', maxAmount: '' };
            document.getElementById('expenseFilterMenu').classList.remove('active');
            updateSummary();
        }

        function applyDebtFilter() {
            debtFilter.sort = document.querySelector('input[name="debtSort"]:checked').value;
            debtFilter.status = document.querySelector('input[name="debtStatus"]:checked').value;
            document.getElementById('debtFilterMenu').classList.remove('active');
            updateSummary();
        }

        function resetDebtFilter() {
            debtFilter = { sort: 'date-desc', minAmount: '', maxAmount: '', dueDate: 'all', status: 'all' };
            document.getElementById('debtFilterMenu').classList.remove('active');
            updateSummary();
        }

        function applyReceivableFilter() {
            receivableFilter.sort = document.querySelector('input[name="receivableSort"]:checked').value;
            receivableFilter.status = document.querySelector('input[name="receivableStatus"]:checked').value;
            document.getElementById('receivableFilterMenu').classList.remove('active');
            updateSummary();
        }

        function resetReceivableFilter() {
            receivableFilter = { sort: 'date-desc', minAmount: '', maxAmount: '', dueDate: 'all', status: 'all' };
            document.getElementById('receivableFilterMenu').classList.remove('active');
            updateSummary();
        }

        function editTransaction(index) {
            currentEditIndex = index;
            const t = transactions[index];
            
            document.getElementById('editType').value = t.type;
            toggleEditDebtSection();
            
            if (t.isDetailed) {
                setEditInputMode('detail');
                document.getElementById('editDetailDescription').value = t.description;
                document.getElementById('editItemPrice').value = t.detailedPrice.toLocaleString('id-ID');
                document.getElementById('editItemQty').value = t.detailedQty;
                calculateEditDetailTotal();
            } else {
                setEditInputMode('quick');
                document.getElementById('editQuickAmount').value = t.amount.toLocaleString('id-ID');
                document.getElementById('editQuickDescription').value = t.description;
            }
            
            document.getElementById('editNotes').value = t.notes || '';
            
            if (t.type === 'debt' || t.type === 'receivable') {
                document.getElementById('editDebtPerson').value = t.debtPerson || '';
                if (t.debtDueDate) {
                    const dueDate = new Date(t.debtDueDate);
                    const year = dueDate.getFullYear();
                    const month = String(dueDate.getMonth() + 1).padStart(2, '0');
                    const day = String(dueDate.getDate()).padStart(2, '0');
                    const hours = String(dueDate.getHours()).padStart(2, '0');
                    const minutes = String(dueDate.getMinutes()).padStart(2, '0');
                    document.getElementById('editDebtDueDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
            }
            
            const date = new Date(t.datetime);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            document.getElementById('editDatetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            if (t.photo) {
                currentEditPhotoData = t.photo;
                document.getElementById('editPhotoPreview').src = t.photo;
                document.getElementById('editPhotoPreview').style.display = 'block';
                document.getElementById('editPhotoUploadText').style.display = 'none';
                document.getElementById('editPhotoInfo').textContent = '‚úì Foto tersimpan';
            } else {
                currentEditPhotoData = null;
                document.getElementById('editPhotoPreview').style.display = 'none';
                document.getElementById('editPhotoUploadText').style.display = 'block';
                document.getElementById('editPhotoInfo').textContent = '';
            }
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('editTransactionDialog').style.display = 'block';
        }

        function closeEditDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('editTransactionDialog').style.display = 'none';
            currentEditIndex = null;
            currentEditPhotoData = null;
            document.getElementById('editPhotoInput').value = '';
        }

        function setEditInputMode(mode) {
            editInputMode = mode;
            const quickBtn = document.getElementById('editQuickModeBtn');
            const detailBtn = document.getElementById('editDetailModeBtn');
            const quickDiv = document.getElementById('editQuickMode');
            const detailDiv = document.getElementById('editDetailMode');
            
            if (mode === 'quick') {
                quickBtn.classList.add('active');
                detailBtn.classList.remove('active');
                quickDiv.classList.remove('hidden');
                detailDiv.classList.add('hidden');
            } else {
                quickBtn.classList.remove('active');
                detailBtn.classList.add('active');
                quickDiv.classList.add('hidden');
                detailDiv.classList.remove('hidden');
            }
        }

        function toggleEditDebtSection() {
            const type = document.getElementById('editType').value;
            const debtSection = document.getElementById('editDebtSection');
            const debtLabel = document.getElementById('editDebtLabel');

            if (type === 'debt') {
                debtSection.classList.remove('hidden');
                debtLabel.textContent = 'Hutang kepada siapa / di mana?';
            } else if (type === 'receivable') {
                debtSection.classList.remove('hidden');
                debtLabel.textContent = 'Piutang dari siapa?';
            } else {
                debtSection.classList.add('hidden');
            }
        }

        function calculateEditDetailTotal() {
            const priceInput = document.getElementById('editItemPrice').value;
            const price = parseAmount(priceInput);
            const qty = parseInt(document.getElementById('editItemQty').value) || 1;
            
            const total = price * qty;
            document.getElementById('editShoppingTotal').textContent = formatCurrency(total);
        }

        function confirmEditTransaction() {
            if (currentEditIndex === null) return;
            
            const type = document.getElementById('editType').value;
            let finalAmount = 0;
            let finalDescription = '';
            let isDetailed = false;
            let detailedPrice = 0;
            let detailedQty = 1;
            
            if (editInputMode === 'quick') {
                const amountInput = document.getElementById('editQuickAmount').value;
                finalAmount = parseAmount(amountInput);
                finalDescription = document.getElementById('editQuickDescription').value;
            } else {
                const priceInput = document.getElementById('editItemPrice').value;
                const price = parseAmount(priceInput);
                const qty = parseInt(document.getElementById('editItemQty').value) || 1;
                
                if (price <= 0) {
                    alert('Mohon isi harga satuan!');
                    return;
                }
                
                finalAmount = price * qty;
                finalDescription = document.getElementById('editDetailDescription').value;
                isDetailed = true;
                detailedPrice = price;
                detailedQty = qty;
            }
            
            if (finalAmount <= 0) {
                alert('Jumlah harus lebih dari 0!');
                return;
            }
            
            if (!finalDescription) {
                alert('Mohon isi deskripsi transaksi!');
                return;
            }
            
            const notes = document.getElementById('editNotes').value;
            const datetime = parseDateTimeManual(document.getElementById('editDatetime').value);
            
            let debtPerson = '';
            let debtDueDate = '';
            
            if (type === 'debt' || type === 'receivable') {
                debtPerson = document.getElementById('editDebtPerson').value.trim();
                const dueDateValue = document.getElementById('editDebtDueDate').value;
                if (dueDateValue) {
                    debtDueDate = parseDateTimeManual(dueDateValue);
                }
            }
            
            const oldTransaction = transactions[currentEditIndex];
            
            transactions[currentEditIndex] = {
                ...oldTransaction,
                type: type,
                amount: finalAmount,
                description: finalDescription,
                notes: notes,
                isDetailed: isDetailed,
                detailedPrice: detailedPrice,
                detailedQty: detailedQty,
                datetime: datetime,
                photo: currentEditPhotoData,
                debtPerson: debtPerson,
                debtDueDate: debtDueDate
            };
    
            saveToStorage(transactions);
            closeEditDialog();
    
            // PERBAIKAN: Force refresh
            forceRefreshAllDisplays();
    
            alert('‚úÖ Transaksi berhasil diupdate!');
        }

        function deleteTransaction(index) {
            const t = transactions[index];
            if (confirm(`Hapus transaksi "${t.description}" sebesar ${formatCurrency(t.amount)}?`)) {
                transactions.splice(index, 1);
                saveToStorage(transactions);
        
                // PERBAIKAN: Force refresh
                forceRefreshAllDisplays();
        
                alert('‚úÖ Transaksi berhasil dihapus!');
            }
        }


        function displayTransactions() {
            const list = document.getElementById('transactionList');
            
            let filtered = transactions;
            
            if (currentHistoryPeriod !== 'all') {
                filtered = getFilteredTransactions(currentHistoryPeriod, selectedHistoryYear, selectedHistoryMonth);
            }
            
            if (currentSearchTerm) {
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(currentSearchTerm) ||
                    (t.notes && t.notes.toLowerCase().includes(currentSearchTerm)) ||
                    (t.debtPerson && t.debtPerson.toLowerCase().includes(currentSearchTerm))
                );
            }
            
            if (currentFilter !== 'all') {
                filtered = filtered.filter(t => t.type === currentFilter);
            }
            
            document.getElementById('transactionCount').textContent = filtered.length;
            
            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-data">Tidak ada transaksi yang sesuai</p>';
                return;
            }
            
            filtered.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            list.innerHTML = filtered.map(t => {
                const originalIndex = transactions.indexOf(t);
                const date = new Date(t.datetime);
                const dateStr = date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let typeIcon = '';
                let typeText = '';
                let amountClass = '';
                
                if (t.type === 'income') {
                    typeIcon = 'üìà';
                    typeText = 'Pemasukan';
                    amountClass = 'income';
                } else if (t.type === 'expense') {
                    typeIcon = 'üìâ';
                    typeText = 'Pengeluaran';
                    amountClass = 'expense';
                } else if (t.type === 'debt') {
                    typeIcon = 'üí≥';
                    typeText = 'Hutang';
                    amountClass = 'debt';
                } else if (t.type === 'receivable') {
                    typeIcon = 'üí∞';
                    typeText = 'Piutang (Orang Berhutang Ke Saya)';
                    amountClass = 'receivable';
                }
                
                const displayAmount = (t.type === 'debt' || t.type === 'receivable') ? getRemainingDebt(t) : t.amount;
                const dueBadge = getDueDateBadge(t);
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div class="transaction-info">
                                <div class="transaction-date">${typeIcon} ${typeText} ‚Ä¢ ${dateStr}</div>
                                <div class="transaction-desc">
                                    ${t.description}
                                    ${t.isPaid ? '<span class="debt-badge badge-paid">‚úì LUNAS</span>' : dueBadge}
                                </div>
                                ${t.isDetailed ? `<div class="transaction-detail">üõí ${formatCurrency(t.detailedPrice)} √ó ${t.detailedQty}</div>` : ''}
                                ${t.notes ? `<div class="transaction-detail">üìù ${t.notes}</div>` : ''}
                                ${t.debtPerson ? `<div class="transaction-detail">üë§ ${t.debtPerson}</div>` : ''}
                                ${t.debtDueDate && !t.isPaid ? `<div class="transaction-detail">‚è∞ Jatuh tempo: ${new Date(t.debtDueDate).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>` : ''}
                                ${(t.type === 'debt' || t.type === 'receivable') && t.amount !== displayAmount ? `<div class="transaction-detail">üí∞ Dari total: ${formatCurrency(t.amount)}</div>` : ''}
                            </div>
                            <div class="transaction-amount ${amountClass}">
                                ${formatCurrency(displayAmount)}
                            </div>
                        </div>
                        ${t.photo ? `
                            <div class="transaction-photo">
                                <img src="${t.photo}" onclick="showPhotoModal('${t.photo}')">
                            </div>
                        ` : ''}
                        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn-edit" onclick="editTransaction(${originalIndex})">‚úèÔ∏è Edit</button>
                            ${(t.type === 'debt' || t.type === 'receivable') && !t.isPaid ? `<button class="btn-pay" onclick="showPaymentDialog(${originalIndex})">üí∞ ${t.type === 'debt' ? 'Bayar' : 'Terima'}</button>` : ''}
                            ${t.payments && t.payments.length > 0 ? `<button class="btn-history" onclick="showPaymentHistory(${originalIndex})">üìú Riwayat</button>` : ''}
                            <button class="btn-delete" onclick="deleteTransaction(${originalIndex})">üóëÔ∏è Hapus</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
		
        function forceRefreshAllDisplays() {
            // Reload data dari storage untuk memastikan sinkronisasi
            transactions = loadFromStorage();
            products = loadProducts();
    
            // Update semua tampilan dengan data fresh
            updateSummary();
            updateNotificationBadge();
            displayTransactions();
            displayProducts();
            displayNotifications();
    
            // Reset expanded states untuk force re-render detail sections
            const wasIncomeExpanded = incomeExpanded;
            const wasExpenseExpanded = expenseExpanded;
            const wasDebtExpanded = debtExpanded;
            const wasReceivableExpanded = receivableExpanded;
    
            // Reset semua ke collapsed
            incomeExpanded = false;
            expenseExpanded = false;
            debtExpanded = false;
            receivableExpanded = false;
    
            // Update sekali
            updateSummary();
    
            // Restore state yang sebelumnya expanded
            if (wasIncomeExpanded) {
                incomeExpanded = true;
            }
            if (wasExpenseExpanded) {
                expenseExpanded = true;
            }
            if (wasDebtExpanded) {
                debtExpanded = true;
            }
            if (wasReceivableExpanded) {
                receivableExpanded = true;
            }
    
            // Update lagi dengan state yang benar
            updateSummary();
        }

        function handleSearch() {
            const input = document.getElementById('searchInput');
            currentSearchTerm = input.value.trim().toLowerCase();
            
            const clearBtn = document.getElementById('clearSearch');
            if (currentSearchTerm) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
            
            displayTransactions();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchTerm = '';
            document.getElementById('clearSearch').classList.remove('visible');
            displayTransactions();
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filterMenu');
            menu.classList.toggle('active');
        }

        function selectFilter(filter) {
            currentFilter = filter;
            
            const options = document.querySelectorAll('.filter-option');
            options.forEach(opt => {
                if (opt.getAttribute('data-filter') === filter) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            const labels = {
                'all': 'Semua',
                'income': 'Pemasukan',
                'expense': 'Pengeluaran',
                'debt': 'Hutang',
                'receivable': 'Piutang (Orang Berhutang Ke Saya)'
            };
            
            document.getElementById('filterLabel').textContent = 'Filter: ' + labels[filter];
            document.getElementById('filterMenu').classList.remove('active');
            
            displayTransactions();
        }

        function showSettingsDialog() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('settingsDialog').style.display = 'block';
        }

        function closeSettingsDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('settingsDialog').style.display = 'none';
        }

        function handleExportJSONClick() {
            const dataToExport = {
                transactions: transactions,
                products: products,
                profile: userProfile,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Backup_Keuangan_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data JSON berhasil di-download!');
        }

        function handleExportExcelClick() {
            showExportDialog();
        }

        function handleImportClick() {
            document.getElementById('importData').click();
        }

        function showLoadingOverlay(text) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = text || 'Memproses...';
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showExportDialog() {
            document.getElementById('exportFileName').value = 'Laporan_Keuangan';
            document.getElementById('exportAll').checked = true;
            toggleExportAll();
            document.getElementById('exportPeriod').value = 'all';
            toggleExportDateInputs();
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('exportDialog').style.display = 'block';
        }

        function closeExportDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('exportDialog').style.display = 'none';
        }

        function toggleExportAll() {
            const all = document.getElementById('exportAll').checked;
            document.getElementById('exportIncome').disabled = all;
            document.getElementById('exportExpense').disabled = all;
            document.getElementById('exportDebt').disabled = all;
            document.getElementById('exportReceivable').disabled = all;
            
            if (all) {
                document.getElementById('exportIncome').checked = false;
                document.getElementById('exportExpense').checked = false;
                document.getElementById('exportDebt').checked = false;
                document.getElementById('exportReceivable').checked = false;
            }
        }

        function toggleExportDateInputs() {
            const period = document.getElementById('exportPeriod').value;
            const customDates = document.getElementById('exportCustomDates');
            
            if (period === 'custom') {
                customDates.classList.remove('hidden');
            } else {
                customDates.classList.add('hidden');
            }
        }

        async function confirmExport() {
            const fileName = document.getElementById('exportFileName').value || 'Laporan_Keuangan';
            const exportAll = document.getElementById('exportAll').checked;
            const period = document.getElementById('exportPeriod').value;
            
            let typesToExport = [];
            if (exportAll) {
                typesToExport = ['income', 'expense', 'debt', 'receivable'];
            } else {
                if (document.getElementById('exportIncome').checked) typesToExport.push('income');
                if (document.getElementById('exportExpense').checked) typesToExport.push('expense');
                if (document.getElementById('exportDebt').checked) typesToExport.push('debt');
                if (document.getElementById('exportReceivable').checked) typesToExport.push('receivable');
            }
            
            if (typesToExport.length === 0) {
                alert('Pilih minimal satu jenis transaksi untuk diekspor!');
                return;
            }
            
            let filtered = transactions.filter(t => typesToExport.includes(t.type));
            
            if (period !== 'all') {
                if (period === 'custom') {
                    const startDate = document.getElementById('exportStartDate').value;
                    const endDate = document.getElementById('exportEndDate').value;
                    
                    if (!startDate || !endDate) {
                        alert('Mohon isi tanggal mulai dan tanggal akhir!');
                        return;
                    }
                    
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999);
                    
                    filtered = filtered.filter(t => {
                        const tDate = new Date(t.datetime);
                        return tDate >= start && tDate <= end;
                    });
                } else {
                    const now = new Date();
                    let startDate;
                    
                    if (period === 'today') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    } else if (period === 'week') {
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - 7);
                    } else if (period === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    } else if (period === 'year') {
                        startDate = new Date(now.getFullYear(), 0, 1);
                    }
                    
                    filtered = filtered.filter(t => new Date(t.datetime) >= startDate);
                }
            }
            
            if (filtered.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            closeExportDialog();
            showLoadingOverlay('Membuat file Excel...');
            
            try {
                await exportToExcel(filtered, fileName);
                hideLoadingOverlay();
                alert('‚úÖ File Excel berhasil di-download!');
            } catch (error) {
                hideLoadingOverlay();
                console.error('Export error:', error);
                alert('‚ùå Gagal membuat file Excel: ' + error.message);
            }
        }

        async function exportToExcel(data, fileName) {
            const workbook = new ExcelJS.Workbook();
            workbook.creator = userProfile.name || 'Pencatat Keuangan';
            workbook.created = new Date();

            const worksheet = workbook.addWorksheet('Laporan Keuangan');

            worksheet.columns = [
                { header: 'No', key: 'no', width: 5 },
                { header: 'Tanggal', key: 'date', width: 20 },
                { header: 'Waktu', key: 'time', width: 12 },
                { header: 'Jenis', key: 'type', width: 25 },
                { header: 'Deskripsi', key: 'description', width: 35 },
                { header: 'Harga Satuan', key: 'unitPrice', width: 15 },
                { header: 'Jumlah', key: 'quantity', width: 10 },
                { header: 'Total', key: 'amount', width: 18 },
                { header: 'Catatan', key: 'notes', width: 30 },
                { header: 'Orang/Tempat', key: 'person', width: 20 },
                { header: 'Jatuh Tempo', key: 'dueDate', width: 20 },
			    { header: 'Bunga', key: 'interest', width: 20 },
                { header: 'Status', key: 'status', width: 15 },
                { header: 'Foto', key: 'photo', width: 20 }
            ];

            worksheet.getRow(1).font = { bold: true, size: 12 };
            worksheet.getRow(1).fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4F46E5' }
            };
            worksheet.getRow(1).font.color = { argb: 'FFFFFFFF' };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.getRow(1).height = 25;

            data.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

            let rowIndex = 2;

            for (let i = 0; i < data.length; i++) {
                const t = data[i];
                const date = new Date(t.datetime);

                const dateStr = date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                const timeStr = date.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let typeText = '';
                let typeColor = 'FF000000';

                if (t.type === 'income') {
                    typeText = 'Pemasukan';
                    typeColor = 'FF10B981';
                } else if (t.type === 'expense') {
                    typeText = 'Pengeluaran';
                    typeColor = 'FFEF4444';
                } else if (t.type === 'debt') {
                    typeText = 'Hutang';
                    typeColor = 'FFF59E0B';
                } else if (t.type === 'receivable') {
                    typeText = 'Piutang';
                    typeColor = 'FF14B8A6';
                }

                const displayAmount = (t.type === 'debt' || t.type === 'receivable') ? getRemainingDebt(t) : t.amount;

                let statusText = '';
                if (t.type === 'debt' || t.type === 'receivable') {
                    statusText = t.isPaid ? 'LUNAS' : 'Belum Lunas';
                } else {
                    statusText = '-';
                }

                const dueDateStr = t.debtDueDate ? new Date(t.debtDueDate).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';

                let interestText = '-';
                if ((t.type === 'debt' || t.type === 'receivable') && t.hasInterest && t.interestRate > 0) {
                    let periodText = '';
                    if (t.interestPeriod === 'day') periodText = '/hari';
                    else if (t.interestPeriod === 'week') periodText = '/minggu';
                    else if (t.interestPeriod === 'month') periodText = '/bulan';
                    else if (t.interestPeriod === 'year') periodText = '/tahun';
                    interestText = t.interestRate + '% ' + periodText;
                }

                const row = worksheet.addRow({
                    no: i + 1,
                    date: dateStr,
                    time: timeStr,
                    type: typeText,
                    description: t.description,
                    unitPrice: t.isDetailed ? t.detailedPrice : '-',
                    quantity: t.isDetailed ? t.detailedQty : '-',
                    amount: displayAmount,
                    notes: t.notes || '-',
                    person: t.debtPerson || '-',
                    dueDate: dueDateStr,
                    interest: interestText,
                    status: statusText,
                    photo: t.photo ? 'Ada' : '-'
                });

                row.getCell('type').font = { color: { argb: typeColor }, bold: true };

                if (t.isDetailed) {
                    row.getCell('unitPrice').numFmt = '"Rp "#,##0';
                    row.getCell('quantity').alignment = { horizontal: 'center' };
                }

                row.getCell('amount').numFmt = '"Rp "#,##0';
                row.getCell('amount').font = { bold: true, color: { argb: typeColor } };
                row.alignment = { vertical: 'middle' };

                if (t.photo) {
                    try {
                        const base64Data = t.photo.split(',')[1];
                        const imageId = workbook.addImage({
                            base64: base64Data,
                            extension: 'png'
                        });

                        row.height = 100;

                        worksheet.addImage(imageId, {
                            tl: { col: 13, row: rowIndex - 1 },
                            br: { col: 14, row: rowIndex }
                        });
                    } catch (error) {
                        console.error('Error adding image:', error);
                    }
                }

                rowIndex++;
            }

            worksheet.eachRow((row, rowNumber) => {
                if (rowNumber > 1) {
                    row.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFE5E7EB' } },
                            left: { style: 'thin', color: { argb: 'FFE5E7EB' } },
                            bottom: { style: 'thin', color: { argb: 'FFE5E7EB' } },
                            right: { style: 'thin', color: { argb: 'FFE5E7EB' } }
                        };
                    });
                }
            });

            const summaryRow = rowIndex + 2;
            worksheet.getCell(`D${summaryRow}`).value = 'RINGKASAN';
            worksheet.getCell(`D${summaryRow}`).font = { bold: true, size: 12 };
            worksheet.getCell(`D${summaryRow}`).alignment = { horizontal: 'left' };

            const totalIncome = data.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = data.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalDebt = data.filter(t => t.type === 'debt').reduce((sum, t) => sum + getRemainingDebt(t), 0);
            const totalReceivable = data.filter(t => t.type === 'receivable').reduce((sum, t) => sum + getRemainingDebt(t), 0);
            const saldo = totalIncome - totalExpense;
            const saldoBersih = saldo - totalDebt + totalReceivable;

            const incomeRow = worksheet.addRow(['', '', '', 'Total Pemasukan', ': ' + formatCurrency(totalIncome)]);
            worksheet.mergeCells(`E${incomeRow.number}:M${incomeRow.number}`);
            incomeRow.getCell(4).font = { bold: true };
            incomeRow.getCell(5).alignment = { horizontal: 'left' };
            incomeRow.getCell(5).font = { bold: true, color: { argb: 'FF10B981' } };

            const expenseRow = worksheet.addRow(['', '', '', 'Total Pengeluaran', ': ' + formatCurrency(totalExpense)]);
            worksheet.mergeCells(`E${expenseRow.number}:M${expenseRow.number}`);
            expenseRow.getCell(4).font = { bold: true };
            expenseRow.getCell(5).alignment = { horizontal: 'left' };
            expenseRow.getCell(5).font = { bold: true, color: { argb: 'FFEF4444' } };

            const debtRow = worksheet.addRow(['', '', '', 'Total Hutang (Belum Lunas)', ': ' + formatCurrency(totalDebt)]);
            worksheet.mergeCells(`E${debtRow.number}:M${debtRow.number}`);
            debtRow.getCell(4).font = { bold: true };
            debtRow.getCell(5).alignment = { horizontal: 'left' };
            debtRow.getCell(5).font = { bold: true, color: { argb: 'FFF59E0B' } };

            const receivableRow = worksheet.addRow(['', '', '', 'Total Piutang (Belum Lunas)', ': ' + formatCurrency(totalReceivable)]);
            worksheet.mergeCells(`E${receivableRow.number}:M${receivableRow.number}`);
            receivableRow.getCell(4).font = { bold: true };
            receivableRow.getCell(5).alignment = { horizontal: 'left' };
            receivableRow.getCell(5).font = { bold: true, color: { argb: 'FF14B8A6' } };

            const saldoRow = worksheet.addRow(['', '', '', 'Saldo Saat Ini', ': ' + formatCurrency(saldo)]);
            worksheet.mergeCells(`E${saldoRow.number}:M${saldoRow.number}`);
            saldoRow.getCell(4).font = { bold: true };
            saldoRow.getCell(5).alignment = { horizontal: 'left' };
            saldoRow.getCell(5).font = { bold: true, color: { argb: 'FF667EEA' } };

            const saldoBersihRow = worksheet.addRow(['', '', '', 'Saldo Bersih', ': ' + formatCurrency(saldoBersih)]);
            worksheet.mergeCells(`E${saldoBersihRow.number}:M${saldoBersihRow.number}`);
            saldoBersihRow.getCell(4).font = { bold: true, size: 12 };
            saldoBersihRow.getCell(5).alignment = { horizontal: 'left' };
            saldoBersihRow.getCell(5).font = { bold: true, size: 12, color: { argb: 'FF667EEA' } };

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${fileName}_${new Date().toISOString().slice(0,10)}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showImportDialog(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.transactions || !Array.isArray(importedData.transactions)) {
                        alert('‚ùå Format file tidak valid!');
                        fileInput.value = '';
                        return;
                    }
                    
                    pendingImportData = importedData;
                    document.getElementById('importCount').textContent = importedData.transactions.length;
                    
                    document.getElementById('modalOverlay').style.display = 'block';
                    document.getElementById('importDialog').style.display = 'block';
                } catch (error) {
                    alert('‚ùå Gagal membaca file: ' + error.message);
                    fileInput.value = '';
                }
            };
            
            reader.readAsText(file);
        }

        function closeImportDialog() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('importDialog').style.display = 'none';
            document.getElementById('importData').value = '';
            pendingImportData = null;
        }

        function confirmImport(mode) {
            if (!pendingImportData) {
                alert('‚ùå Tidak ada data untuk diimport!');
                return;
            }
            
            if (mode === 'merge') {
                transactions.push(...pendingImportData.transactions);
                alert(`‚úÖ Berhasil menambahkan ${pendingImportData.transactions.length} transaksi!`);
            } else if (mode === 'replace') {
                transactions = pendingImportData.transactions;
                alert(`‚úÖ Data berhasil diganti dengan ${pendingImportData.transactions.length} transaksi!`);
            }
            
            if (pendingImportData.products && Array.isArray(pendingImportData.products)) {
                if (confirm(`Import juga ${pendingImportData.products.length} produk?`)) {
                    products = pendingImportData.products;
                }
            }
            
            if (pendingImportData.profile) {
                if (confirm('Import juga profil pengguna?')) {
                    userProfile = pendingImportData.profile;
                    localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
                    updateProfileDisplay();
                }
            }
            
            saveToStorage(transactions);
            saveProducts();
            updateSummary();
            updateNotificationBadge();
            displayTransactions();
            displayProducts();
            closeImportDialog();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è PERINGATAN!\n\nHapus SEMUA data transaksi, produk, dan profil?\n\nData yang sudah dihapus TIDAK BISA dikembalikan!')) {
                if (confirm('Anda yakin 100%? Ini adalah konfirmasi terakhir!')) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(PRODUCTS_KEY);
                    localStorage.removeItem(PROFILE_KEY);
                    
                    transactions = [];
                    products = [];
                    userProfile = {};
                    
                    updateProfileDisplay();
                    updateSummary();
                    updateNotificationBadge();
                    displayTransactions();
                    displayProducts();
                    updateStorageInfo(true);
                    
                    alert('‚úÖ Semua data berhasil dihapus!');
                    closeSettingsDialog();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            transactions = loadFromStorage();
            products = loadProducts();
            loadUserProfile();
            
            updateProfileDisplay();
            updateSummary();
            updateNotificationBadge();
            displayTransactions();
            displayProducts();
            updateStorageInfo(true);
            
            setDefaultManualDateTime();
            startRealtimeUpdate();
            
            document.getElementById('modalOverlay').addEventListener('click', function() {
                closeProfileDialog();
                closePaymentDialog();
                closeHistoryDialog();
                closeEditDialog();
                closeExportDialog();
                closeImportDialog();
                closeSettingsDialog();
                closeAddProductDialog();
                closeEditProductDialog();
                closeAddStockDialog();
            });
            
            document.querySelectorAll('.modal-dialog').forEach(dialog => {
                dialog.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            setInterval(updateNotificationBadge, 60000);
            
            window.addEventListener('beforeunload', function() {
                saveToStorage(transactions);
                saveProducts();
            });
            
            // PERBAIKAN: Close ALL menus when clicking outside
            document.addEventListener('click', function(e) {
                // Close product menu
                if (!e.target.closest('.product-card')) {
                    document.querySelectorAll('.product-menu-popup').forEach(m => {
                        m.classList.remove('active');
                    });
                }
    
                // Close product filter menu
                if (!e.target.closest('.product-filter-box')) {
                    const productFilterMenu = document.getElementById('productFilterMenu');
                    if (productFilterMenu) {
                        productFilterMenu.classList.remove('active');
                    }
                }
    
                // Close transaction filter menu
                if (!e.target.closest('.filter-dropdown')) {
                    const filterMenu = document.getElementById('filterMenu');
                    if (filterMenu) {
                        filterMenu.classList.remove('active');
                    }
                }
    
                // Close detail filter menus (income, expense, debt, receivable)
                if (!e.target.closest('.filter-detail-dropdown')) {
                    const incomeFilterMenu = document.getElementById('incomeFilterMenu');
                    const expenseFilterMenu = document.getElementById('expenseFilterMenu');
                    const debtFilterMenu = document.getElementById('debtFilterMenu');
                    const receivableFilterMenu = document.getElementById('receivableFilterMenu');
        
                    if (incomeFilterMenu) incomeFilterMenu.classList.remove('active');
                    if (expenseFilterMenu) expenseFilterMenu.classList.remove('active');
                    if (debtFilterMenu) debtFilterMenu.classList.remove('active');
                    if (receivableFilterMenu) receivableFilterMenu.classList.remove('active');
                }
            });
			
            updateNextYearButton();
            updateHistoryNextYearButton();
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveToStorage(transactions);
                saveProducts();
                alert('‚úÖ Data tersimpan!');
            }
            
            if (e.key === 'Escape') {
                document.getElementById('modalOverlay').style.display = 'none';
                document.querySelectorAll('.modal-dialog').forEach(dialog => {
                    dialog.style.display = 'none';
                });
                closePhotoModal();
            }
        });

        console.log('‚úÖ Aplikasi Pencatat Keuangan siap digunakan!');
    </script>
</body>
</html>
